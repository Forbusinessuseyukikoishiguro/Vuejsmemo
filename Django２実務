# Django + Vue.js + MySQL ä¸Šç´šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼å‡¦ç†å®Œå…¨ã‚¬ã‚¤ãƒ‰ - ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«å‘ã‘

## ç›®æ¬¡
1. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆåŸå‰‡](#architecture)
2. [Djangoå´ï¼šé«˜åº¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼å‡¦ç†](#django-advanced)
3. [Vue.jså´ï¼šãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªå®Ÿè£…](#vue-professional)
4. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–æˆ¦ç•¥](#database-optimization)
5. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–](#security-hardening)
6. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£](#performance)
7. [ãƒ†ã‚¹ãƒˆæˆ¦ç•¥](#testing)

---

## 1. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆåŸå‰‡ {#architecture}

### MVC/MVTãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ­£ã—ã„å®Ÿè£…

```python
# models.py - ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«å±¤ã®è¨­è¨ˆ
from django.db import models
from django.core.validators import RegexValidator, MinLengthValidator
from django.utils import timezone
import uuid

class BaseModel(models.Model):
    """
    ã™ã¹ã¦ã®ãƒ¢ãƒ‡ãƒ«ã®åŸºåº•ã‚¯ãƒ©ã‚¹
    å…±é€šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨æ©Ÿèƒ½ã‚’æä¾›
    """
    # UUIDã‚’ä¸»ã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šãƒ»åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ å¯¾å¿œï¼‰
    id = models.UUIDField(
        primary_key=True,           # ä¸»ã‚­ãƒ¼ã¨ã—ã¦è¨­å®š
        default=uuid.uuid4,         # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«UUID4ã‚’ä½¿ç”¨
        editable=False,             # ç®¡ç†ç”»é¢ã§ç·¨é›†ä¸å¯
        help_text="ã‚·ã‚¹ãƒ†ãƒ å†…ã§ä¸€æ„ã®ID"
    )
    
    # ä½œæˆæ—¥æ™‚ï¼ˆè‡ªå‹•è¨­å®šã€ç·¨é›†ä¸å¯ï¼‰
    created_at = models.DateTimeField(
        auto_now_add=True,          # ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆæ™‚ã«è‡ªå‹•è¨­å®š
        db_index=True,              # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆï¼ˆæ¤œç´¢é«˜é€ŸåŒ–ï¼‰
        help_text="ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆæ—¥æ™‚"
    )
    
    # æ›´æ–°æ—¥æ™‚ï¼ˆè‡ªå‹•æ›´æ–°ï¼‰
    updated_at = models.DateTimeField(
        auto_now=True,              # ãƒ¬ã‚³ãƒ¼ãƒ‰æ›´æ–°æ™‚ã«è‡ªå‹•æ›´æ–°
        db_index=True,              # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
        help_text="ãƒ¬ã‚³ãƒ¼ãƒ‰æœ€çµ‚æ›´æ–°æ—¥æ™‚"
    )
    
    # è«–ç†å‰Šé™¤ãƒ•ãƒ©ã‚°ï¼ˆç‰©ç†å‰Šé™¤ã‚’é¿ã‘ã‚‹ï¼‰
    is_deleted = models.BooleanField(
        default=False,              # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å‰Šé™¤ã•ã‚Œã¦ã„ãªã„
        db_index=True,              # å‰Šé™¤çŠ¶æ…‹ã§ã®æ¤œç´¢ã‚’é«˜é€ŸåŒ–
        help_text="è«–ç†å‰Šé™¤ãƒ•ãƒ©ã‚°"
    )
    
    class Meta:
        abstract = True             # æŠ½è±¡ãƒ¢ãƒ‡ãƒ«ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã•ã‚Œãªã„ï¼‰
        ordering = ['-created_at']  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚½ãƒ¼ãƒˆé †

class User(BaseModel):
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ« - ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºå¯¾å¿œè¨­è¨ˆ
    """
    
    # åå‰ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ï¼ˆæ—¥æœ¬èªãƒ»è‹±èªãƒ»ãƒã‚¤ãƒ•ãƒ³ãƒ»ã‚¹ãƒšãƒ¼ã‚¹è¨±å¯ï¼‰
    name_validator = RegexValidator(
        regex=r'^[a-zA-Z\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\s\-]+$',
        message='åå‰ã¯æ—¥æœ¬èªã€è‹±èªã€ãƒã‚¤ãƒ•ãƒ³ã€ã‚¹ãƒšãƒ¼ã‚¹ã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™',
        code='invalid_name'
    )
    
    name = models.CharField(
        max_length=100,                     # æœ€å¤§100æ–‡å­—
        validators=[                        # ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼é©ç”¨
            name_validator,
            MinLengthValidator(1, 'åå‰ã¯å¿…é ˆã§ã™')
        ],
        db_index=True,                      # æ¤œç´¢ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        help_text="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡¨ç¤ºå"
    )
    
    # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ï¼‰
    email = models.EmailField(
        unique=True,                        # ä¸€æ„åˆ¶ç´„
        db_index=True,                      # æ¤œç´¢é«˜é€ŸåŒ–
        error_messages={
            'unique': 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™'
        },
        help_text="ãƒ­ã‚°ã‚¤ãƒ³ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"
    )
    
    # å¹´é½¢ï¼ˆç¯„å›²åˆ¶ç´„ï¼‰
    age = models.PositiveSmallIntegerField(
        null=True,                          # NULLè¨±å¯
        blank=True,                         # ãƒ•ã‚©ãƒ¼ãƒ ã§ç©ºç™½è¨±å¯
        db_index=True,                      # å¹´é½¢æ¤œç´¢ç”¨
        help_text="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¹´é½¢"
    )
    
    # éƒ½å¸‚ï¼ˆé¸æŠè‚¢åˆ¶é™ï¼‰
    CITY_CHOICES = [
        ('tokyo', 'æ±äº¬'),
        ('osaka', 'å¤§é˜ª'),
        ('nagoya', 'åå¤å±‹'),
        ('fukuoka', 'ç¦å²¡'),
        ('sapporo', 'æœ­å¹Œ'),
        ('sendai', 'ä»™å°'),
        ('hiroshima', 'åºƒå³¶'),
        ('other', 'ãã®ä»–')
    ]
    
    city = models.CharField(
        max_length=20,                      # é¸æŠè‚¢ã‚­ãƒ¼ã®æœ€å¤§é•·
        choices=CITY_CHOICES,               # é¸æŠè‚¢åˆ¶é™
        blank=True,                         # ç©ºç™½è¨±å¯
        db_index=True,                      # åœ°åŸŸæ¤œç´¢ç”¨
        help_text="å±…ä½éƒ½å¸‚"
    )
    
    # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆç„¡åŠ¹åŒ–æ©Ÿèƒ½ï¼‰
    is_active = models.BooleanField(
        default=True,                       # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
        db_index=True,                      # çŠ¶æ…‹æ¤œç´¢ç”¨
        help_text="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹"
    )
    
    class Meta:
        db_table = 'users'                  # ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’æ˜ç¤º
        verbose_name = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'           # ç®¡ç†ç”»é¢è¡¨ç¤ºå
        verbose_name_plural = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'    # ç®¡ç†ç”»é¢è¤‡æ•°å½¢
        indexes = [
            # è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆã‚ˆãä½¿ã‚ã‚Œã‚‹æ¤œç´¢æ¡ä»¶ã®çµ„ã¿åˆã‚ã›ï¼‰
            models.Index(fields=['city', 'age'], name='idx_user_city_age'),
            models.Index(fields=['is_active', 'created_at'], name='idx_user_active_created'),
        ]
    
    def __str__(self):
        """
        ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ–‡å­—åˆ—è¡¨ç¾
        ç®¡ç†ç”»é¢ã‚„ãƒ‡ãƒãƒƒã‚°ã§è¡¨ç¤ºã•ã‚Œã‚‹
        """
        return f"{self.name} ({self.email})"
    
    def save(self, *args, **kwargs):
        """
        ä¿å­˜å‡¦ç†ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
        ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
        """
        # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å°æ–‡å­—ã«æ­£è¦åŒ–
        if self.email:
            self.email = self.email.lower().strip()
        
        # åå‰ã®å‰å¾Œç©ºç™½ã‚’å‰Šé™¤
        if self.name:
            self.name = self.name.strip()
        
        # å¹´é½¢ã®ç¯„å›²ãƒã‚§ãƒƒã‚¯
        if self.age is not None and (self.age < 0 or self.age > 150):
            raise ValueError('å¹´é½¢ã¯0-150ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„')
        
        # è¦ªã‚¯ãƒ©ã‚¹ã®saveãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—
        super().save(*args, **kwargs)
```

---

## 2. Djangoå´ï¼šé«˜åº¦ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼å‡¦ç† {#django-advanced}

### ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªViewè¨­è¨ˆ

```python
# views.py - ä¼æ¥­ãƒ¬ãƒ™ãƒ«ã®Viewå®Ÿè£…
from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
from django.views.decorators.http import require_http_methods
from django.utils.decorators import method_decorator
from django.views.generic import View
from django.db import transaction, connection
from django.core.paginator import Paginator, EmptyPage, PageNotAnInteger
from django.core.cache import cache
from django.conf import settings
import json
import logging
import time
from typing import Dict, Any, Optional, List
from dataclasses import dataclass

# ãƒ­ã‚¬ãƒ¼è¨­å®š
logger = logging.getLogger(__name__)

@dataclass
class APIResponse:
    """
    API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¨™æº–åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹
    ä¸€è²«æ€§ã®ã‚ã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‚’ä¿è¨¼
    """
    success: bool
    data: Optional[Dict[str, Any]] = None
    error: Optional[str] = None
    errors: Optional[Dict[str, List[str]]] = None
    pagination: Optional[Dict[str, Any]] = None
    meta: Optional[Dict[str, Any]] = None
    
    def to_dict(self) -> Dict[str, Any]:
        """è¾æ›¸å½¢å¼ã«å¤‰æ›ï¼ˆJSONåŒ–ç”¨ï¼‰"""
        result = {'success': self.success}
        
        if self.data is not None:
            result['data'] = self.data
        if self.error is not None:
            result['error'] = self.error
        if self.errors is not None:
            result['errors'] = self.errors
        if self.pagination is not None:
            result['pagination'] = self.pagination
        if self.meta is not None:
            result['meta'] = self.meta
            
        return result

class APIResponseMixin:
    """
    APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†ã®Mixin
    çµ±ä¸€ã•ã‚ŒãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‚’æä¾›
    """
    
    def json_response(self, response: APIResponse, status: int = 200) -> JsonResponse:
        """JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç”Ÿæˆ"""
        return JsonResponse(
            response.to_dict(),
            status=status,
            json_dumps_params={'ensure_ascii': False}  # æ—¥æœ¬èªæ–‡å­—åŒ–ã‘é˜²æ­¢
        )
    
    def success_response(self, data: Dict[str, Any], 
                        pagination: Optional[Dict[str, Any]] = None,
                        meta: Optional[Dict[str, Any]] = None) -> JsonResponse:
        """æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹"""
        response = APIResponse(
            success=True,
            data=data,
            pagination=pagination,
            meta=meta
        )
        return self.json_response(response)
    
    def error_response(self, error: str, status: int = 400, 
                      errors: Optional[Dict[str, List[str]]] = None) -> JsonResponse:
        """ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹"""
        response = APIResponse(
            success=False,
            error=error,
            errors=errors
        )
        return self.json_response(response, status=status)

class BaseAPIView(View, APIResponseMixin):
    """
    ã™ã¹ã¦ã®APIãƒ“ãƒ¥ãƒ¼ã®åŸºåº•ã‚¯ãƒ©ã‚¹
    å…±é€šæ©Ÿèƒ½ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’æä¾›
    """
    
    def dispatch(self, request, *args, **kwargs):
        """
        ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‰å‡¦ç†ãƒ»å¾Œå‡¦ç†ã‚’è¡Œã†
        ãƒ­ã‚°è¨˜éŒ²ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        """
        # ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹æ™‚é–“ã‚’è¨˜éŒ²
        start_time = time.time()
        
        # ãƒªã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
        logger.info(f"API Request: {request.method} {request.path} from {request.META.get('REMOTE_ADDR')}")
        
        try:
            # è¦ªã‚¯ãƒ©ã‚¹ã®dispatchãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œ
            response = super().dispatch(request, *args, **kwargs)
            
            # ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã‚’è¨ˆç®—
            process_time = time.time() - start_time
            
            # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã«å‡¦ç†æ™‚é–“ã‚’è¿½åŠ 
            response['X-Process-Time'] = f"{process_time:.3f}s"
            
            # æˆåŠŸãƒ­ã‚°ã‚’è¨˜éŒ²
            logger.info(f"API Response: {response.status_code} ({process_time:.3f}s)")
            
            return response
            
        except Exception as e:
            # äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ
            logger.error(f"Unexpected error in {self.__class__.__name__}: {str(e)}", exc_info=True)
            
            # ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒã§ã¯è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’éš ã™
            if settings.DEBUG:
                error_message = f"Internal server error: {str(e)}"
            else:
                error_message = "å†…éƒ¨ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
            
            return self.error_response(error_message, status=500)

@method_decorator(csrf_exempt, name='dispatch')
class UserDetailView(BaseAPIView):
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°å–å¾—API
    URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ãŸé«˜åº¦ãªå®Ÿè£…
    """
    
    def get(self, request, user_id: str) -> JsonResponse:
        """
        ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°æƒ…å ±ã‚’å–å¾—
        
        Args:
            request: HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            user_id: URL ã‹ã‚‰æŠ½å‡ºã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆUUIDæ–‡å­—åˆ—ï¼‰
        
        Returns:
            JsonResponse: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼æƒ…å ±
        """
        
        # UUIDã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
        try:
            import uuid
            uuid.UUID(user_id)  # UUIDå½¢å¼ã‹ãƒã‚§ãƒƒã‚¯
        except ValueError:
            return self.error_response("ç„¡åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§ã™", status=400)
        
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã‚’ç”Ÿæˆ
        cache_key = f"user_detail_{user_id}"
        
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ
        cached_data = cache.get(cache_key)
        if cached_data:
            logger.info(f"Cache hit for user {user_id}")
            return self.success_response(
                data={'user': cached_data},
                meta={'cache_hit': True}
            )
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªå®Ÿè¡Œ
        try:
            with connection.cursor() as cursor:
                # æœ€é©åŒ–ã•ã‚ŒãŸSQLã‚¯ã‚¨ãƒªï¼ˆJOINã‚„ã‚µãƒ–ã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨ï¼‰
                sql = """
                    SELECT 
                        u.id,
                        u.name,
                        u.email,
                        u.age,
                        u.city,
                        u.is_active,
                        u.created_at,
                        u.updated_at,
                        -- é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ã®é›†è¨ˆæƒ…å ±ã‚‚å–å¾—
                        (SELECT COUNT(*) FROM orders o WHERE o.user_id = u.id) as order_count,
                        (SELECT MAX(o.created_at) FROM orders o WHERE o.user_id = u.id) as last_order_date
                    FROM users u
                    WHERE u.id = %s 
                        AND u.is_deleted = FALSE 
                        AND u.is_active = TRUE
                """
                
                # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼åŒ–ã‚¯ã‚¨ãƒªã§SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–
                cursor.execute(sql, [user_id])
                
                row = cursor.fetchone()
                
                if not row:
                    return self.error_response("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", status=404)
                
                # ã‚«ãƒ©ãƒ åã‚’å–å¾—ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹é€ åŒ–
                columns = [desc[0] for desc in cursor.description]
                user_data = dict(zip(columns, row))
                
                # æ—¥æ™‚ãƒ‡ãƒ¼ã‚¿ã‚’ ISO 8601 å½¢å¼ã«å¤‰æ›
                for field in ['created_at', 'updated_at', 'last_order_date']:
                    if user_data.get(field):
                        user_data[field] = user_data[field].isoformat()
                
                # éƒ½å¸‚åã‚’æ—¥æœ¬èªè¡¨ç¤ºã«å¤‰æ›
                city_display = dict(User.CITY_CHOICES).get(user_data['city'], user_data['city'])
                user_data['city_display'] = city_display
                
                # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ï¼ˆ5åˆ†é–“ï¼‰
                cache.set(cache_key, user_data, 300)
                
                return self.success_response(
                    data={'user': user_data},
                    meta={
                        'cache_hit': False,
                        'query_time': time.time()
                    }
                )
                
        except Exception as e:
            logger.error(f"Database error in UserDetailView: {str(e)}")
            return self.error_response("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", status=500)

@method_decorator(csrf_exempt, name='dispatch')
class UserSearchView(BaseAPIView):
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢API
    é«˜åº¦ãªã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼å‡¦ç†ã¨å‹•çš„SQLã‚¯ã‚¨ãƒªæ§‹ç¯‰
    """
    
    # æ¤œç´¢å¯èƒ½ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å®šç¾©
    SEARCHABLE_FIELDS = {
        'name': {
            'type': 'text',
            'operator': 'ILIKE',  # å¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„éƒ¨åˆ†ä¸€è‡´
            'max_length': 100
        },
        'email': {
            'type': 'text',
            'operator': '=',
            'max_length': 254
        },
        'city': {
            'type': 'choice',
            'choices': [choice[0] for choice in User.CITY_CHOICES],
            'operator': '='
        },
        'age_min': {
            'type': 'integer',
            'operator': '>=',
            'min_value': 0,
            'max_value': 150,
            'target_field': 'age'
        },
        'age_max': {
            'type': 'integer',
            'operator': '<=',
            'min_value': 0,
            'max_value': 150,
            'target_field': 'age'
        }
    }
    
    def get(self, request) -> JsonResponse:
        """
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
        
        ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼:
            name: åå‰ã§ã®éƒ¨åˆ†ä¸€è‡´æ¤œç´¢
            email: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã®å®Œå…¨ä¸€è‡´æ¤œç´¢
            city: éƒ½å¸‚ã§ã®æ¤œç´¢
            age_min: æœ€å°å¹´é½¢
            age_max: æœ€å¤§å¹´é½¢
            page: ãƒšãƒ¼ã‚¸ç•ªå·ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1ï¼‰
            page_size: 1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®ã‚¢ã‚¤ãƒ†ãƒ æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 20, æœ€å¤§: 100ï¼‰
            sort_by: ã‚½ãƒ¼ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: created_atï¼‰
            sort_order: ã‚½ãƒ¼ãƒˆé †ï¼ˆasc/descã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: descï¼‰
        """
        
        # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼å–å¾—ã¨æ¤œè¨¼
        search_params = self._extract_search_params(request)
        if isinstance(search_params, JsonResponse):
            return search_params  # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
        
        pagination_params = self._extract_pagination_params(request)
        if isinstance(pagination_params, JsonResponse):
            return pagination_params  # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
        
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã‚’ç”Ÿæˆï¼ˆæ¤œç´¢æ¡ä»¶ã¨ãƒšãƒ¼ã‚¸ãƒ³ã‚°æƒ…å ±ã‹ã‚‰ï¼‰
        cache_key = self._generate_cache_key(search_params, pagination_params)
        
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ
        cached_result = cache.get(cache_key)
        if cached_result:
            return self.success_response(
                data=cached_result,
                meta={'cache_hit': True}
            )
        
        try:
            with connection.cursor() as cursor:
                # å‹•çš„SQLã‚¯ã‚¨ãƒªã‚’æ§‹ç¯‰
                query_builder = self._build_search_query(search_params, pagination_params)
                
                # ãƒ¡ã‚¤ãƒ³ã‚¯ã‚¨ãƒªå®Ÿè¡Œ
                cursor.execute(query_builder['main_query'], query_builder['params'])
                rows = cursor.fetchall()
                
                # ã‚«ãƒ©ãƒ åã‚’å–å¾—
                columns = [desc[0] for desc in cursor.description]
                
                # çµæœã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                users = []
                for row in rows:
                    user_data = dict(zip(columns, row))
                    
                    # æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                    for field in ['created_at', 'updated_at']:
                        if user_data.get(field):
                            user_data[field] = user_data[field].isoformat()
                    
                    # éƒ½å¸‚åè¡¨ç¤º
                    if user_data.get('city'):
                        user_data['city_display'] = dict(User.CITY_CHOICES).get(
                            user_data['city'], user_data['city']
                        )
                    
                    users.append(user_data)
                
                # ç·ä»¶æ•°ã‚’å–å¾—
                cursor.execute(query_builder['count_query'], query_builder['count_params'])
                total_count = cursor.fetchone()[0]
                
                # ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’è¨ˆç®—
                pagination_info = self._calculate_pagination(
                    total_count, 
                    pagination_params['page'], 
                    pagination_params['page_size']
                )
                
                result_data = {
                    'users': users,
                    'search_params': search_params,
                    'pagination': pagination_info
                }
                
                # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ï¼ˆ2åˆ†é–“ï¼‰
                cache.set(cache_key, result_data, 120)
                
                return self.success_response(
                    data=result_data,
                    meta={'cache_hit': False}
                )
                
        except Exception as e:
            logger.error(f"Search error: {str(e)}")
            return self.error_response("æ¤œç´¢ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", status=500)
    
    def _extract_search_params(self, request) -> Dict[str, Any]:
        """æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’æŠ½å‡ºãƒ»æ¤œè¨¼"""
        params = {}
        errors = {}
        
        for param_name, config in self.SEARCHABLE_FIELDS.items():
            value = request.GET.get(param_name)
            
            if not value:
                continue
            
            # ãƒ‡ãƒ¼ã‚¿å‹åˆ¥ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if config['type'] == 'text':
                value = value.strip()
                if len(value) > config.get('max_length', 255):
                    errors[param_name] = [f"{param_name}ã¯{config['max_length']}æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„"]
                    continue
                params[param_name] = value
                
            elif config['type'] == 'integer':
                try:
                    value = int(value)
                    if 'min_value' in config and value < config['min_value']:
                        errors[param_name] = [f"{param_name}ã¯{config['min_value']}ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„"]
                        continue
                    if 'max_value' in config and value > config['max_value']:
                        errors[param_name] = [f"{param_name}ã¯{config['max_value']}ä»¥ä¸‹ã§å…¥åŠ›ã—ã¦ãã ã•ã„"]
                        continue
                    params[param_name] = value
                except ValueError:
                    errors[param_name] = [f"{param_name}ã¯æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„"]
                    continue
                    
            elif config['type'] == 'choice':
                if value not in config['choices']:
                    errors[param_name] = [f"{param_name}ã¯æœ‰åŠ¹ãªé¸æŠè‚¢ã‹ã‚‰é¸ã‚“ã§ãã ã•ã„"]
                    continue
                params[param_name] = value
        
        if errors:
            return self.error_response("ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚¨ãƒ©ãƒ¼", status=400, errors=errors)
        
        return params
    
    def _extract_pagination_params(self, request) -> Dict[str, Any]:
        """ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’æŠ½å‡ºãƒ»æ¤œè¨¼"""
        try:
            page = int(request.GET.get('page', 1))
            if page < 1:
                page = 1
        except ValueError:
            return self.error_response("pageã¯æ­£ã®æ•´æ•°ã§æŒ‡å®šã—ã¦ãã ã•ã„", status=400)
        
        try:
            page_size = int(request.GET.get('page_size', 20))
            if page_size < 1:
                page_size = 20
            elif page_size > 100:  # æœ€å¤§åˆ¶é™
                page_size = 100
        except ValueError:
            return self.error_response("page_sizeã¯æ­£ã®æ•´æ•°ã§æŒ‡å®šã—ã¦ãã ã•ã„", status=400)
        
        # ã‚½ãƒ¼ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼
        sort_by = request.GET.get('sort_by', 'created_at')
        allowed_sort_fields = ['name', 'email', 'age', 'city', 'created_at', 'updated_at']
        if sort_by not in allowed_sort_fields:
            return self.error_response(f"sort_byã¯{allowed_sort_fields}ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„", status=400)
        
        sort_order = request.GET.get('sort_order', 'desc').lower()
        if sort_order not in ['asc', 'desc']:
            return self.error_response("sort_orderã¯ascã¾ãŸã¯descã§æŒ‡å®šã—ã¦ãã ã•ã„", status=400)
        
        return {
            'page': page,
            'page_size': page_size,
            'sort_by': sort_by,
            'sort_order': sort_order
        }
    
    def _build_search_query(self, search_params: Dict[str, Any], 
                          pagination_params: Dict[str, Any]) -> Dict[str, Any]:
        """å‹•çš„SQLã‚¯ã‚¨ãƒªã‚’æ§‹ç¯‰"""
        
        # åŸºæœ¬SELECTæ–‡
        base_select = """
            SELECT 
                id, name, email, age, city, is_active, created_at, updated_at
            FROM users
        """
        
        base_count = "SELECT COUNT(*) FROM users"
        
        # WHEREæ¡ä»¶ã‚’æ§‹ç¯‰
        where_conditions = ["is_deleted = FALSE", "is_active = TRUE"]
        query_params = []
        
        for param_name, value in search_params.items():
            config = self.SEARCHABLE_FIELDS[param_name]
            target_field = config.get('target_field', param_name)
            operator = config['operator']
            
            if operator == 'ILIKE':
                where_conditions.append(f"{target_field} ILIKE %s")
                query_params.append(f"%{value}%")
            else:
                where_conditions.append(f"{target_field} {operator} %s")
                query_params.append(value)
        
        where_clause = " AND ".join(where_conditions)
        
        # ORDER BYå¥ã‚’æ§‹ç¯‰
        sort_direction = "ASC" if pagination_params['sort_order'] == 'asc' else "DESC"
        order_by = f"ORDER BY {pagination_params['sort_by']} {sort_direction}"
        
        # LIMIT/OFFSETå¥ã‚’æ§‹ç¯‰
        offset = (pagination_params['page'] - 1) * pagination_params['page_size']
        limit_offset = f"LIMIT %s OFFSET %s"
        
        # æœ€çµ‚ã‚¯ã‚¨ãƒªã‚’çµ„ã¿ç«‹ã¦
        main_query = f"{base_select} WHERE {where_clause} {order_by} {limit_offset}"
        count_query = f"{base_count} WHERE {where_clause}"
        
        main_params = query_params + [pagination_params['page_size'], offset]
        
        return {
            'main_query': main_query,
            'params': main_params,
            'count_query': count_query,
            'count_params': query_params
        }
    
    def _generate_cache_key(self, search_params: Dict[str, Any], 
                          pagination_params: Dict[str, Any]) -> str:
        """ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã‚’ç”Ÿæˆ"""
        import hashlib
        
        # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’æ–‡å­—åˆ—ã«å¤‰æ›ã—ã¦ãƒãƒƒã‚·ãƒ¥åŒ–
        params_str = json.dumps({
            'search': search_params,
            'pagination': pagination_params
        }, sort_keys=True)
        
        hash_value = hashlib.md5(params_str.encode()).hexdigest()
        return f"user_search_{hash_value}"
    
    def _calculate_pagination(self, total_count: int, page: int, page_size: int) -> Dict[str, Any]:
        """ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’è¨ˆç®—"""
        total_pages = (total_count + page_size - 1) // page_size
        
        return {
            'current_page': page,
            'page_size': page_size,
            'total_count': total_count,
            'total_pages': total_pages,
            'has_previous': page > 1,
            'has_next': page < total_pages,
            'previous_page': page - 1 if page > 1 else None,
            'next_page': page + 1 if page < total_pages else None
        }

@method_decorator(csrf_exempt, name='dispatch')
class UserCreateView(BaseAPIView):
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆAPI
    é«˜åº¦ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†
    """
    
    def post(self, request) -> JsonResponse:
        """
        æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
        
        ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«JSONå½¢å¼ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’é€ä¿¡
        """
        try:
            # JSONãƒ‡ãƒ¼ã‚¿ã‚’è§£æ
            json_data = json.loads(request.body.decode('utf-8'))
        except json.JSONDecodeError as e:
            return self.error_response(f"ç„¡åŠ¹ãªJSONå½¢å¼ã§ã™: {str(e)}", status=400)
        
        # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        validation_result = self._validate_user_data(json_data)
        if isinstance(validation_result, JsonResponse):
            return validation_result
        
        validated_data = validation_result
        
        # ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
        try:
            with transaction.atomic():  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
                
                # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
                with connection.cursor() as cursor:
                    cursor.execute(
                        "SELECT COUNT(*) FROM users WHERE email = %s AND is_deleted = FALSE",
                        [validated_data['email']]
                    )
                    
                    if cursor.fetchone()[0] > 0:
                        return self.error_response(
                            "ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™", 
                            status=400
                        )
                    
                    # æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æŒ¿å…¥
                    insert_sql = """
                        INSERT INTO users (id, name, email, age, city, created_at, updated_at) 
                        VALUES (uuid_generate_v4(), %s, %s, %s, %s, NOW(), NOW())
                        RETURNING id, name, email, age, city, created_at, updated_at
                    """
                    
                    cursor.execute(insert_sql, [
                        validated_data['name'],
                        validated_data['email'],
                        validated_data.get('age'),
                        validated_data.get('city')
                    ])
                    
                    # ä½œæˆã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
                    row = cursor.fetchone()
                    columns = [desc[0] for desc in cursor.description]
                    user_data = dict(zip(columns, row))
                    
                    # UUIDã‚’æ–‡å­—åˆ—ã«å¤‰æ›
                    user_data['id'] = str(user_data['id'])
                    
                    # æ—¥æ™‚ã‚’ISOå½¢å¼ã«å¤‰æ›
                    for field in ['created_at', 'updated_at']:
                        if user_data.get(field):
                            user_data[field] = user_data[field].isoformat()
                    
                    # éƒ½å¸‚åè¡¨ç¤ºã‚’è¿½åŠ 
                    if user_data.get('city'):
                        user_data['city_display'] = dict(User.CITY_CHOICES).get(
                            user_data['city'], user_data['city']
                        )
                    
                    # ä½œæˆãƒ­ã‚°ã‚’è¨˜éŒ²
                    logger.info(f"User created: {user_data['id']} ({user_data['email']})")
                    
                    return self.success_response(
                        data={
                            'user': user_data,
                            'message': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ'
                        },
                        meta={'created': True}
                    )
                    
        except Exception as e:
            logger.error(f"User creation error: {str(e)}")
            return self.error_response("ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ", status=500)
    
    def _validate_user_data(self, data: Dict[str, Any]) -> Dict[str, Any]:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³"""
        errors = {}
        validated_data = {}
        
        # åå‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        name = data.get('name', '').strip()
        if not name:
            errors['name'] = ['åå‰ã¯å¿…é ˆã§ã™']
        elif len(name) > 100:
            errors['name'] = ['åå‰ã¯100æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„']
        else:
            # æ–‡å­—ç¨®ãƒã‚§ãƒƒã‚¯
            import re
            if not re.match(r'^[a-zA-Z\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\s\-]+$', name):
                errors['name'] = ['åå‰ã¯æ—¥æœ¬èªã€è‹±èªã€ãƒã‚¤ãƒ•ãƒ³ã€ã‚¹ãƒšãƒ¼ã‚¹ã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™']
            else:
                validated_data['name'] = name
        
        # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        email = data.get('email', '').strip().lower()
        if not email:
            errors['email'] = ['ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™']
        else:
            # Django ã® EmailValidator ã‚’ä½¿ç”¨
            from django.core.validators import validate_email
            from django.core.exceptions import ValidationError
            
            try:
                validate_email(email)
                validated_data['email'] = email
            except ValidationError:
                errors['email'] = ['æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„']
        
        # å¹´é½¢ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        age = data.get('age')
        if age is not None:
            if not isinstance(age, int) or age < 0 or age > 150:
                errors['age'] = ['å¹´é½¢ã¯0-150ã®æ•´æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„']
            else:
                validated_data['age'] = age
        
        # éƒ½å¸‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        city = data.get('city')
        if city:
            valid_cities = [choice[0] for choice in User.CITY_CHOICES]
            if city not in valid_cities:
                errors['city'] = [f'éƒ½å¸‚ã¯{valid_cities}ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„']
            else:
                validated_data['city'] = city
        
        if errors:
            return self.error_response("ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼", status=400, errors=errors)
        
        return validated_data
```

---

## 3. Vue.jså´ï¼šãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªå®Ÿè£… {#vue-professional}

### ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºãƒ¬ãƒ™ãƒ«ã® API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­è¨ˆ

```javascript
// api/client.js - ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªAPIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
import axios from 'axios'

/**
 * APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®šã‚¯ãƒ©ã‚¹
 * ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºãƒ¬ãƒ™ãƒ«ã®HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ©Ÿèƒ½ã‚’æä¾›
 */
class APIClient {
  constructor() {
    // Axiosã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
    this.client = axios.create({
      baseURL: process.env.VUE_APP_API_BASE_URL || 'http://localhost:8000/api',
      timeout: 30000, // 30ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }
    })
    
    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼ã‚’è¨­å®š
    this.setupRequestInterceptors()
    
    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼ã‚’è¨­å®š
    this.setupResponseInterceptors()
    
    // ãƒªãƒˆãƒ©ã‚¤è¨­å®š
    this.retryConfig = {
      retries: 3,           // æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°
      retryDelay: 1000,     // ãƒªãƒˆãƒ©ã‚¤é–“éš”ï¼ˆãƒŸãƒªç§’ï¼‰
      retryCondition: (error) => {
        // 5xx ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®å ´åˆã«ãƒªãƒˆãƒ©ã‚¤
        return !error.response || (error.response.status >= 500 && error.response.status <= 599)
      }
    }
  }
  
  /**
   * ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼ã®è¨­å®š
   * èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ä»˜åŠ ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ­ã‚°ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š
   */
  setupRequestInterceptors() {
    this.client.interceptors.request.use(
      (config) => {
        // ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹æ™‚é–“ã‚’è¨˜éŒ²
        config.metadata = { startTime: new Date() }
        
        // èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è‡ªå‹•ä»˜åŠ 
        const token = this.getAuthToken()
        if (token) {
          config.headers['Authorization'] = `Bearer ${token}`
        }
        
        // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’è‡ªå‹•ä»˜åŠ ï¼ˆDjangoå¯¾å¿œï¼‰
        const csrfToken = this.getCSRFToken()
        if (csrfToken) {
          config.headers['X-CSRFToken'] = csrfToken
        }
        
        // ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDã‚’ç”Ÿæˆï¼ˆãƒ­ã‚°ãƒˆãƒ¬ãƒ¼ã‚¹ç”¨ï¼‰
        config.headers['X-Request-ID'] = this.generateRequestId()
        
        // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ­ã‚°å‡ºåŠ›
        if (process.env.NODE_ENV === 'development') {
          console.log('ğŸš€ API Request:', {
            method: config.method.toUpperCase(),
            url: config.url,
            params: config.params,
            data: config.data
          })
        }
        
        return config
      },
      (error) => {
        console.error('âŒ Request interceptor error:', error)
        return Promise.reject(error)
      }
    )
  }
  
  /**
   * ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼ã®è¨­å®š
   * ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ­ã‚°ã€ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½
   */
  setupResponseInterceptors() {
    this.client.interceptors.response.use(
      (response) => {
        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã‚’è¨ˆç®—
        const endTime = new Date()
        const duration = endTime.getTime() - response.config.metadata.startTime.getTime()
        
        // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ­ã‚°å‡ºåŠ›
        if (process.env.NODE_ENV === 'development') {
          console.log('âœ… API Response:', {
            status: response.status,
            url: response.config.url,
            duration: `${duration}ms`,
            data: response.data
          })
        }
        
        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¨™æº–åŒ–
        return this.normalizeResponse(response)
      },
      async (error) => {
        // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’è¨˜éŒ²
        this.logError(error)
        
        // ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
        if (this.shouldRetry(error)) {
          return this.retryRequest(error)
        }
        
        // ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ¨™æº–åŒ–
        return Promise.reject(this.normalizeError(error))
      }
    )
  }
  
  /**
   * ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¨™æº–åŒ–
   * ã™ã¹ã¦ã®APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’çµ±ä¸€ã•ã‚ŒãŸå½¢å¼ã«å¤‰æ›
   */
  normalizeResponse(response) {
    const normalizedResponse = {
      success: true,
      data: response.data,
      status: response.status,
      headers: response.headers,
      meta: {
        timestamp: new Date().toISOString(),
        requestId: response.config.headers['X-Request-ID']
      }
    }
    
    // Django APIã®æ¨™æº–ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯
    if (response.data && typeof response.data.success === 'boolean') {
      normalizedResponse.success = response.data.success
      normalizedResponse.data = response.data.data || response.data
      normalizedResponse.pagination = response.data.pagination
      normalizedResponse.errors = response.data.errors
    }
    
    return normalizedResponse
  }
  
  /**
   * ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¨™æº–åŒ–
   * ã™ã¹ã¦ã®APIã‚¨ãƒ©ãƒ¼ã‚’çµ±ä¸€ã•ã‚ŒãŸå½¢å¼ã«å¤‰æ›
   */
  normalizeError(error) {
    const normalizedError = {
      success: false,
      message: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
      status: 500,
      errors: {},
      meta: {
        timestamp: new Date().toISOString(),
        requestId: error.config?.headers?.['X-Request-ID'] || null
      }
    }
    
    if (error.response) {
      // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚ŒãŸå ´åˆ
      normalizedError.status = error.response.status
      normalizedError.data = error.response.data
      
      // Django APIã®ã‚¨ãƒ©ãƒ¼å½¢å¼ã‚’å‡¦ç†
      if (error.response.data) {
        normalizedError.message = error.response.data.error || normalizedError.message
        normalizedError.errors = error.response.data.errors || {}
      }
      
      // HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      switch (error.response.status) {
        case 400:
          normalizedError.message = normalizedError.message || 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä¸æ­£ã§ã™'
          break
        case 401:
          normalizedError.message = 'èªè¨¼ãŒå¿…è¦ã§ã™'
          break
        case 403:
          normalizedError.message = 'ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“'
          break
        case 404:
          normalizedError.message = 'ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
          break
        case 429:
          normalizedError.message = 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆé »åº¦ãŒé«˜ã™ãã¾ã™'
          break
        case 500:
          normalizedError.message = 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
          break
      }
    } else if (error.request) {
      // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
      normalizedError.message = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
      normalizedError.status = 0
    }
    
    return normalizedError
  }
  
  /**
   * ãƒªãƒˆãƒ©ã‚¤åˆ¤å®š
   */
  shouldRetry(error) {
    // ãƒªãƒˆãƒ©ã‚¤å›æ•°ã‚’ãƒã‚§ãƒƒã‚¯
    const retryCount = error.config.__retryCount || 0
    if (retryCount >= this.retryConfig.retries) {
      return false
    }
    
    // ãƒªãƒˆãƒ©ã‚¤æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯
    return this.retryConfig.retryCondition(error)
  }
  
  /**
   * ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒªãƒˆãƒ©ã‚¤å®Ÿè¡Œ
   */
  async retryRequest(error) {
    const retryCount = (error.config.__retryCount || 0) + 1
    error.config.__retryCount = retryCount
    
    console.warn(`ğŸ”„ Retrying request (${retryCount}/${this.retryConfig.retries})...`)
    
    // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§ãƒªãƒˆãƒ©ã‚¤é–“éš”ã‚’èª¿æ•´
    const delay = this.retryConfig.retryDelay * Math.pow(2, retryCount - 1)
    await this.sleep(delay)
    
    return this.client.request(error.config)
  }
  
  /**
   * èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
   */
  getAuthToken() {
    // localStorageã€Vuexã€Cookieãªã©ã‹ã‚‰å–å¾—
    return localStorage.getItem('authToken')
  }
  
  /**
   * CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
   */
  getCSRFToken() {
    // Cookieã‹ã‚‰å–å¾—
    const cookies = document.cookie.split(';')
    for (let cookie of cookies) {
      const [name, value] = cookie.trim().split('=')
      if (name === 'csrftoken') {
        return value
      }
    }
    return null
  }
  
  /**
   * ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDã‚’ç”Ÿæˆ
   */
  generateRequestId() {
    return Math.random().toString(36).substr(2, 9) + Date.now().toString(36)
  }
  
  /**
   * ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¨˜éŒ²
   */
  logError(error) {
    const errorLog = {
      timestamp: new Date().toISOString(),
      url: error.config?.url,
      method: error.config?.method,
      status: error.response?.status,
      message: error.message,
      requestId: error.config?.headers?.['X-Request-ID']
    }
    
    console.error('âŒ API Error:', errorLog)
    
    // æœ¬ç•ªç’°å¢ƒã§ã¯å¤–éƒ¨ãƒ­ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã«é€ä¿¡
    if (process.env.NODE_ENV === 'production') {
      this.sendErrorToLoggingService(errorLog)
    }
  }
  
  /**
   * å¤–éƒ¨ãƒ­ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¨ãƒ©ãƒ¼ã‚’é€ä¿¡ï¼ˆä¾‹ï¼šSentry, LogRocketç­‰ï¼‰
   */
  sendErrorToLoggingService(errorLog) {
    // å®Ÿè£…ä¾‹ï¼šSentryã«ã‚¨ãƒ©ãƒ¼ã‚’é€ä¿¡
    // Sentry.captureException(new Error(errorLog.message), { extra: errorLog })
  }
  
  /**
   * æŒ‡å®šæ™‚é–“å¾…æ©Ÿ
   */
  sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms))
  }
  
  // ===== APIãƒ¡ã‚½ãƒƒãƒ‰ =====
  
  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°å–å¾—
   */
  async getUserDetail(userId) {
    return this.client.get(`/users/${userId}/`)
  }
  
  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
   */
  async searchUsers(params = {}) {
    return this.client.get('/users/search/', { params })
  }
  
  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
   */
  async createUser(userData) {
    return this.client.post('/users/', userData)
  }
  
  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°
   */
  async updateUser(userId, userData) {
    return this.client.patch(`/users/${userId}/`, userData)
  }
  
  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
   */
  async deleteUser(userId) {
    return this.client.delete(`/users/${userId}/`)
  }
}

// ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
export default new APIClient()
```

### é«˜åº¦ãªVueã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…

```vue
<!-- components/UserManagement.vue -->
<template>
  <div class="user-management">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="management-header">
      <h1 class="header-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
      <div class="header-actions">
        <button 
          @click="showCreateModal = true" 
          class="btn btn-primary"
          :disabled="loading"
        >
          <i class="icon-plus"></i>
          æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
        </button>
        <button 
          @click="refreshData" 
          class="btn btn-secondary"
          :disabled="loading"
        >
          <i class="icon-refresh" :class="{ 'spinning': loading }"></i>
          æ›´æ–°
        </button>
      </div>
    </header>

    <!-- æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <div class="search-section">
      <div class="search-form">
        <div class="form-row">
          <!-- åå‰æ¤œç´¢ -->
          <div class="form-group">
            <label for="searchName">åå‰</label>
            <input
              id="searchName"
              v-model="searchFilters.name"
              @input="debounceSearch"
              type="text"
              placeholder="éƒ¨åˆ†ä¸€è‡´ã§æ¤œç´¢"
              class="form-control"
            />
          </div>

          <!-- éƒ½å¸‚ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
          <div class="form-group">
            <label for="searchCity">éƒ½å¸‚</label>
            <select
              id="searchCity"
              v-model="searchFilters.city"
              @change="performSearch"
              class="form-control"
            >
              <option value="">ã™ã¹ã¦</option>
              <option
                v-for="city in cityOptions"
                :key="city.value"
                :value="city.value"
              >
                {{ city.label }}
              </option>
            </select>
          </div>

          <!-- å¹´é½¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
          <div class="form-group age-range">
            <label>å¹´é½¢</label>
            <div class="age-inputs">
              <input
                v-model.number="searchFilters.age_min"
                @input="debounceSearch"
                type="number"
                min="0"
                max="150"
                placeholder="æœ€å°"
                class="form-control age-input"
              />
              <span class="age-separator">ã€œ</span>
              <input
                v-model.number="searchFilters.age_max"
                @input="debounceSearch"
                type="number"
                min="0"
                max="150"
                placeholder="æœ€å¤§"
                class="form-control age-input"
              />
            </div>
          </div>

          <!-- æ¤œç´¢ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="form-group">
            <label>&nbsp;</label>
            <div class="search-actions">
              <button
                @click="performSearch"
                :disabled="loading"
                class="btn btn-primary"
              >
                <i class="icon-search"></i>
                æ¤œç´¢
              </button>
              <button
                @click="clearFilters"
                class="btn btn-outline"
              >
                <i class="icon-clear"></i>
                ã‚¯ãƒªã‚¢
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="table-section">
      <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ -->
      <div v-if="loading && !users.length" class="loading-container">
        <div class="loading-spinner"></div>
        <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>

      <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
      <div v-else-if="error" class="error-container">
        <div class="error-message">
          <i class="icon-error"></i>
          <h3>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
          <p>{{ error }}</p>
          <button @click="refreshData" class="btn btn-primary">
            å†è©¦è¡Œ
          </button>
        </div>
      </div>

      <!-- ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« -->
      <div v-else-if="users.length > 0" class="table-container">
        <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ± -->
        <div class="table-info">
          <span class="result-count">
            {{ pagination.total_count }}ä»¶ä¸­ 
            {{ ((pagination.current_page - 1) * pagination.page_size) + 1 }}ã€œ{{ 
              Math.min(pagination.current_page * pagination.page_size, pagination.total_count) 
            }}ä»¶ã‚’è¡¨ç¤º
          </span>
          
          <!-- ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºé¸æŠ -->
          <div class="page-size-selector">
            <label>è¡¨ç¤ºä»¶æ•°:</label>
            <select 
              v-model="pagination.page_size" 
              @change="changePageSize"
              class="form-control-sm"
            >
              <option :value="10">10ä»¶</option>
              <option :value="20">20ä»¶</option>
              <option :value="50">50ä»¶</option>
              <option :value="100">100ä»¶</option>
            </select>
          </div>
        </div>

        <!-- ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“ -->
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th
                  v-for="column in tableColumns"
                  :key="column.key"
                  :class="{ 'sortable': column.sortable, 'active': currentSort === column.key }"
                  @click="column.sortable && handleSort(column.key)"
                >
                  {{ column.label }}
                  <i
                    v-if="column.sortable"
                    :class="getSortIcon(column.key)"
                    class="sort-icon"
                  ></i>
                </th>
                <th class="actions-column">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <tr
                v-for="user in users"
                :key="user.id"
                class="table-row"
                :class="{ 'inactive': !user.is_active }"
              >
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼å -->
                <td class="user-name">
                  <div class="user-info">
                    <strong>{{ user.name }}</strong>
                    <span v-if="!user.is_active" class="inactive-badge">ç„¡åŠ¹</span>
                  </div>
                </td>

                <!-- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ -->
                <td class="user-email">
                  <a :href="`mailto:${user.email}`">{{ user.email }}</a>
                </td>

                <!-- å¹´é½¢ -->
                <td class="user-age">
                  {{ user.age || '-' }}æ­³
                </td>

                <!-- éƒ½å¸‚ -->
                <td class="user-city">
                  {{ user.city_display || '-' }}
                </td>

                <!-- ä½œæˆæ—¥æ™‚ -->
                <td class="user-created">
                  {{ formatDate(user.created_at) }}
                </td>

                <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
                <td class="actions">
                  <div class="action-buttons">
                    <button
                      @click="editUser(user)"
                      class="btn btn-sm btn-outline"
                      title="ç·¨é›†"
                    >
                      <i class="icon-edit"></i>
                    </button>
                    <button
                      @click="toggleUserStatus(user)"
                      :class="['btn', 'btn-sm', user.is_active ? 'btn-warning' : 'btn-success']"
                      :title="user.is_active ? 'ç„¡åŠ¹åŒ–' : 'æœ‰åŠ¹åŒ–'"
                    >
                      <i :class="user.is_active ? 'icon-pause' : 'icon-play'"></i>
                    </button>
                    <button
                      @click="deleteUser(user)"
                      class="btn btn-sm btn-danger"
                      title="å‰Šé™¤"
                    >
                      <i class="icon-delete"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="pagination-container">
          <div class="pagination-info">
            ãƒšãƒ¼ã‚¸ {{ pagination.current_page }} / {{ pagination.total_pages }}
          </div>
          
          <nav class="pagination">
            <!-- æœ€åˆã®ãƒšãƒ¼ã‚¸ -->
            <button
              @click="changePage(1)"
              :disabled="pagination.current_page === 1"
              class="btn btn-pagination"
              title="æœ€åˆã®ãƒšãƒ¼ã‚¸"
            >
              <i class="icon-first"></i>
            </button>

            <!-- å‰ã®ãƒšãƒ¼ã‚¸ -->
            <button
              @click="changePage(pagination.current_page - 1)"
              :disabled="!pagination.has_previous"
              class="btn btn-pagination"
              title="å‰ã®ãƒšãƒ¼ã‚¸"
            >
              <i class="icon-prev"></i>
            </button>

            <!-- ãƒšãƒ¼ã‚¸ç•ªå· -->
            <template v-for="page in paginationPages" :key="page">
              <button
                v-if="page !== '...'"
                @click="changePage(page)"
                :class="['btn', 'btn-pagination', { 'active': page === pagination.current_page }]"
              >
                {{ page }}
              </button>
              <span v-else class="pagination-ellipsis">...</span>
            </template>

            <!-- æ¬¡ã®ãƒšãƒ¼ã‚¸ -->
            <button
              @click="changePage(pagination.current_page + 1)"
              :disabled="!pagination.has_next"
              class="btn btn-pagination"
              title="æ¬¡ã®ãƒšãƒ¼ã‚¸"
            >
              <i class="icon-next"></i>
            </button>

            <!-- æœ€å¾Œã®ãƒšãƒ¼ã‚¸ -->
            <button
              @click="changePage(pagination.total_pages)"
              :disabled="pagination.current_page === pagination.total_pages"
              class="btn btn-pagination"
              title="æœ€å¾Œã®ãƒšãƒ¼ã‚¸"
            >
              <i class="icon-last"></i>
            </button>
          </nav>
        </div>
      </div>

      <!-- ãƒ‡ãƒ¼ã‚¿ãªã— -->
      <div v-else class="empty-container">
        <div class="empty-message">
          <i class="icon-empty"></i>
          <h3>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h3>
          <p>æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
          <button @click="clearFilters" class="btn btn-primary">
            ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
          </button>
        </div>
      </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <UserFormModal
      v-if="showCreateModal || showEditModal"
      :visible="showCreateModal || showEditModal"
      :user="editingUser"
      :mode="editingUser ? 'edit' : 'create'"
      @close="closeModal"
      @save="handleUserSave"
    />

    <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <ConfirmModal
      v-if="showDeleteModal"
      :visible="showDeleteModal"
      title="ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ç¢ºèª"
      :message="`ã€Œ${deletingUser?.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`"
      danger
      @confirm="confirmDelete"
      @cancel="showDeleteModal = false"
    />

    <!-- é€šçŸ¥ãƒˆãƒ¼ã‚¹ãƒˆ -->
    <Toast
      v-for="notification in notifications"
      :key="notification.id"
      :notification="notification"
      @close="removeNotification"
    />
  </div>
</template>

<script>
import { ref, reactive, computed, onMounted, watch } from 'vue'
import APIClient from '@/api/client'
import UserFormModal from './UserFormModal.vue'
import ConfirmModal from './ConfirmModal.vue'
import Toast from './Toast.vue'
import { debounce } from 'lodash-es'

export default {
  name: 'UserManagement',
  components: {
    UserFormModal,
    ConfirmModal,
    Toast
  },
  
  setup() {
    // ===== ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ‡ãƒ¼ã‚¿ =====
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ
    const users = ref([])
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
    const loading = ref(false)
    
    // ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹
    const error = ref(null)
    
    // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    const searchFilters = reactive({
      name: '',
      city: '',
      age_min: null,
      age_max: null
    })
    
    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±
    const pagination = reactive({
      current_page: 1,
      page_size: 20,
      total_count: 0,
      total_pages: 0,
      has_previous: false,
      has_next: false
    })
    
    // ã‚½ãƒ¼ãƒˆæƒ…å ±
    const currentSort = ref('created_at')
    const sortOrder = ref('desc')
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«çŠ¶æ…‹
    const showCreateModal = ref(false)
    const showEditModal = ref(false)
    const showDeleteModal = ref(false)
    
    // ç·¨é›†ãƒ»å‰Šé™¤å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼
    const editingUser = ref(null)
    const deletingUser = ref(null)
    
    // é€šçŸ¥ãƒªã‚¹ãƒˆ
    const notifications = ref([])
    
    // ===== è¨ˆç®—ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ =====
    
    // éƒ½å¸‚é¸æŠè‚¢
    const cityOptions = computed(() => [
      { value: 'tokyo', label: 'æ±äº¬' },
      { value: 'osaka', label: 'å¤§é˜ª' },
      { value: 'nagoya', label: 'åå¤å±‹' },
      { value: 'fukuoka', label: 'ç¦å²¡' },
      { value: 'sapporo', label: 'æœ­å¹Œ' },
      { value: 'sendai', label: 'ä»™å°' },
      { value: 'hiroshima', label: 'åºƒå³¶' },
      { value: 'other', label: 'ãã®ä»–' }
    ])
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ©ãƒ å®šç¾©
    const tableColumns = computed(() => [
      { key: 'name', label: 'åå‰', sortable: true },
      { key: 'email', label: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', sortable: true },
      { key: 'age', label: 'å¹´é½¢', sortable: true },
      { key: 'city', label: 'éƒ½å¸‚', sortable: true },
      { key: 'created_at', label: 'ä½œæˆæ—¥æ™‚', sortable: true }
    ])
    
    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒšãƒ¼ã‚¸ç•ªå·é…åˆ—
    const paginationPages = computed(() => {
      const currentPage = pagination.current_page
      const totalPages = pagination.total_pages
      const delta = 2 // ç¾åœ¨ãƒšãƒ¼ã‚¸ã®å‰å¾Œã«è¡¨ç¤ºã™ã‚‹ãƒšãƒ¼ã‚¸æ•°
      
      const pages = []
      
      // æœ€åˆã®ãƒšãƒ¼ã‚¸ã¯å¸¸ã«è¡¨ç¤º
      if (totalPages > 0) {
        pages.push(1)
      }
      
      // çœç•¥è¨˜å·ã¨ä¸­é–“ãƒšãƒ¼ã‚¸ã‚’è¨ˆç®—
      const startPage = Math.max(2, currentPage - delta)
      const endPage = Math.min(totalPages - 1, currentPage + delta)
      
      if (startPage > 2) {
        pages.push('...')
      }
      
      for (let i = startPage; i <= endPage; i++) {
        pages.push(i)
      }
      
      if (endPage < totalPages - 1) {
        pages.push('...')
      }
      
      // æœ€å¾Œã®ãƒšãƒ¼ã‚¸ï¼ˆæœ€åˆã®ãƒšãƒ¼ã‚¸ã¨é•ã†å ´åˆï¼‰
      if (totalPages > 1) {
        pages.push(totalPages)
      }
      
      return pages
    })
    
    // ===== ãƒ¡ã‚½ãƒƒãƒ‰ =====
    
    /**
     * ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
     */
    const loadData = async () => {
      loading.value = true
      error.value = null
      
      try {
        // æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’æ§‹ç¯‰
        const params = {
          page: pagination.current_page,
          page_size: pagination.page_size,
          sort_by: currentSort.value,
          sort_order: sortOrder.value
        }
        
        // ç©ºã§ãªã„æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¿½åŠ 
        Object.keys(searchFilters).forEach(key => {
          const value = searchFilters[key]
          if (value !== '' && value !== null && value !== undefined) {
            params[key] = value
          }
        })
        
        // APIå‘¼ã³å‡ºã—
        const response = await APIClient.searchUsers(params)
        
        if (response.success) {
          users.value = response.data.users || []
          
          // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’æ›´æ–°
          if (response.data.pagination) {
            Object.assign(pagination, response.data.pagination)
          }
        } else {
          throw new Error(response.message || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ')
        }
        
      } catch (err) {
        console.error('Data loading error:', err)
        error.value = err.message || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
        
        // ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚’è¡¨ç¤º
        addNotification('error', 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼', error.value)
        
      } finally {
        loading.value = false
      }
    }
    
    /**
     * æ¤œç´¢å®Ÿè¡Œï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ï¼‰
     */
    const debounceSearch = debounce(() => {
      pagination.current_page = 1 // æ¤œç´¢æ™‚ã¯1ãƒšãƒ¼ã‚¸ç›®ã«æˆ»ã‚‹
      loadData()
    }, 500)
    
    /**
     * æ¤œç´¢å®Ÿè¡Œï¼ˆå³åº§ï¼‰
     */
    const performSearch = () => {
      pagination.current_page = 1
      loadData()
    }
    
    /**
     * ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢
     */
    const clearFilters = () => {
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
      Object.keys(searchFilters).forEach(key => {
        if (typeof searchFilters[key] === 'string') {
          searchFilters[key] = ''
        } else {
          searchFilters[key] = null
        }
      })
      
      // ã‚½ãƒ¼ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
      currentSort.value = 'created_at'
      sortOrder.value = 'desc'
      
      // 1ãƒšãƒ¼ã‚¸ç›®ã«æˆ»ã£ã¦æ¤œç´¢
      pagination.current_page = 1
      loadData()
    }
    
    /**
     * ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
     */
    const refreshData = () => {
      loadData()
      addNotification('info', 'ãƒ‡ãƒ¼ã‚¿æ›´æ–°', 'ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸ')
    }
    
    /**
     * ã‚½ãƒ¼ãƒˆå‡¦ç†
     */
    const handleSort = (column) => {
      if (currentSort.value === column) {
        // åŒã˜ã‚«ãƒ©ãƒ ã®å ´åˆã¯æ˜‡é †ãƒ»é™é †ã‚’åˆ‡ã‚Šæ›¿ãˆ
        sortOrder.value = sortOrder.value === 'asc' ? 'desc' : 'asc'
      } else {
        // ç•°ãªã‚‹ã‚«ãƒ©ãƒ ã®å ´åˆã¯é™é †ã‹ã‚‰é–‹å§‹
        currentSort.value = column
        sortOrder.value = 'desc'
      }
      
      pagination.current_page = 1
      loadData()
    }
    
    /**
     * ã‚½ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
     */
    const getSortIcon = (column) => {
      if (currentSort.value !== column) {
        return 'icon-sort'
      }
      return sortOrder.value === 'asc' ? 'icon-sort-up' : 'icon-sort-down'
    }
    
    /**
     * ãƒšãƒ¼ã‚¸å¤‰æ›´
     */
    const changePage = (page) => {
      if (page >= 1 && page <= pagination.total_pages) {
        pagination.current_page = page
        loadData()
      }
    }
    
    /**
     * ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºå¤‰æ›´
     */
    const changePageSize = () => {
      pagination.current_page = 1
      loadData()
    }
    
    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†
     */
    const editUser = (user) => {
      editingUser.value = { ...user } // ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ
      showEditModal.value = true
    }
    
    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
     */
    const deleteUser = (user) => {
      deletingUser.value = user
      showDeleteModal.value = true
    }
    
    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ç¢ºèª
     */
    const confirmDelete = async () => {
      try {
        loading.value = true
        
        const response = await APIClient.deleteUser(deletingUser.value.id)
        
        if (response.success) {
          addNotification('success', 'å‰Šé™¤å®Œäº†', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ')
          
          // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
          await loadData()
        } else {
          throw new Error(response.message || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ')
        }
        
      } catch (err) {
        console.error('Delete error:', err)
        addNotification('error', 'å‰Šé™¤ã‚¨ãƒ©ãƒ¼', err.message || 'å‰Šé™¤å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')
        
      } finally {
        loading.value = false
        showDeleteModal.value = false
        deletingUser.value = null
      }
    }
    
    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ‡ã‚Šæ›¿ãˆ
     */
    const toggleUserStatus = async (user) => {
      try {
        loading.value = true
        
        const response = await APIClient.updateUser(user.id, {
          is_active: !user.is_active
        })
        
        if (response.success) {
          const action = user.is_active ? 'ç„¡åŠ¹åŒ–' : 'æœ‰åŠ¹åŒ–'
          addNotification('success', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´', `ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’${action}ã—ã¾ã—ãŸ`)
          
          // ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
          user.is_active = !user.is_active
        } else {
          throw new Error(response.message || 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ')
        }
        
      } catch (err) {
        console.error('Status toggle error:', err)
        addNotification('error', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã‚¨ãƒ©ãƒ¼', err.message)
        
      } finally {
        loading.value = false
      }
    }
    
    /**
     * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
     */
    const closeModal = () => {
      showCreateModal.value = false
      showEditModal.value = false
      editingUser.value = null
    }
    
    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¿å­˜å‡¦ç†
     */
    const handleUserSave = async (userData) => {
      try {
        loading.value = true
        
        let response
        if (editingUser.value) {
          // æ›´æ–°
          response = await APIClient.updateUser(editingUser.value.id, userData)
        } else {
          // ä½œæˆ
          response = await APIClient.createUser(userData)
        }
        
        if (response.success) {
          const action = editingUser.value ? 'æ›´æ–°' : 'ä½œæˆ'
          addNotification('success', `ãƒ¦ãƒ¼ã‚¶ãƒ¼${action}`, `ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’${action}ã—ã¾ã—ãŸ`)
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
          closeModal()
          
          // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
          await loadData()
        } else {
          throw new Error(response.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ')
        }
        
      } catch (err) {
        console.error('Save error:', err)
        addNotification('error', 'ä¿å­˜ã‚¨ãƒ©ãƒ¼', err.message)
        
      } finally {
        loading.value = false
      }
    }
    
    /**
     * é€šçŸ¥ã‚’è¿½åŠ 
     */
    const addNotification = (type, title, message) => {
      const notification = {
        id: Date.now() + Math.random(),
        type, // 'success', 'error', 'warning', 'info'
        title,
        message,
        timestamp: new Date()
      }
      
      notifications.value.push(notification)
      
      // 5ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
      setTimeout(() => {
        removeNotification(notification.id)
      }, 5000)
    }
    
    /**
     * é€šçŸ¥ã‚’å‰Šé™¤
     */
    const removeNotification = (notificationId) => {
      const index = notifications.value.findIndex(n => n.id === notificationId)
      if (index > -1) {
        notifications.value.splice(index, 1)
      }
    }
    
    /**
     * æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
     */
    const formatDate = (dateString) => {
      if (!dateString) return '-'
      
      const date = new Date(dateString)
      return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      })
    }
    
    // ===== ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ« =====
    
    onMounted(() => {
      loadData()
    })
    
    // ===== Return =====
    
    return {
      // ãƒ‡ãƒ¼ã‚¿
      users,
      loading,
      error,
      searchFilters,
      pagination,
      currentSort,
      sortOrder,
      showCreateModal,
      showEditModal,
      showDeleteModal,
      editingUser,
      deletingUser,
      notifications,
      
      // è¨ˆç®—ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
      cityOptions,
      tableColumns,
      paginationPages,
      
      // ãƒ¡ã‚½ãƒƒãƒ‰
      loadData,
      debounceSearch,
      performSearch,
      clearFilters,
      refreshData,
      handleSort,
      getSortIcon,
      changePage,
      changePageSize,
      editUser,
      deleteUser,
      confirmDelete,
      toggleUserStatus,
      closeModal,
      handleUserSave,
      addNotification,
      removeNotification,
      formatDate
    }
  }
}
</script>

<style scoped>
/* ===== ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« ===== */
.user-management {
  padding: 2rem;
  background-color: #f8f9fa;
  min-height: 100vh;
}

/* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
.management-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
  padding: 1.5rem;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.header-title {
  margin: 0;
  color: #2c3e50;
  font-size: 1.5rem;
  font-weight: 600;
}

.header-actions {
  display: flex;
  gap: 1rem;
}

/* ===== æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== */
.search-section {
  margin-bottom: 2rem;
}

.search-form {
  background: white;
  padding: 1.5rem;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 200px;
  gap: 1rem;
  align-items: end;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group label {
  font-weight: 500;
  margin-bottom: 0.5rem;
  color: #495057;
}

.form-control {
  padding: 0.75rem;
  border: 1px solid #ced4da;
  border-radius: 6px;
  font-size: 0.95rem;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.age-range .age-inputs {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.age-input {
  flex: 1;
}

.age-separator {
  color: #6c757d;
  font-weight: 500;
}

.search-actions {
  display: flex;
  gap: 0.5rem;
}

/* ===== ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« ===== */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1rem;
  border: none;
  border-radius: 6px;
  font-size: 0.95rem;
  font-weight: 500;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.15s ease-in-out;
}

.btn:disabled {
  opacity: 0.65;
  cursor: not-allowed;
}

.btn-primary {
  background-color: #007bff;
  color: white;
}

.btn-primary:hover:not(:disabled) {
  background-color: #0056b3;
}

.btn-secondary {
  background-color: #6c757d;
  color: white;
}

.btn-outline {
  background-color: transparent;
  border: 1px solid #ced4da;
  color: #495057;
}

.btn-outline:hover {
  background-color: #f8f9fa;
}

.btn-sm {
  padding: 0.375rem 0.75rem;
  font-size: 0.875rem;
}

.btn-success {
  background-color: #28a745;
  color: white;
}

.btn-warning {
  background-color: #ffc107;
  color: #212529;
}

.btn-danger {
  background-color: #dc3545;
  color: white;
}

/* ===== ãƒ†ãƒ¼ãƒ–ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== */
.table-section {
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  overflow: hidden;
}

.table-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid #dee2e6;
  background-color: #f8f9fa;
}

.result-count {
  font-weight: 500;
  color: #495057;
}

.page-size-selector {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.form-control-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
  border: 1px solid #ced4da;
  border-radius: 4px;
}

/* ===== ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« ===== */
.table-responsive {
  overflow-x: auto;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
}

.data-table th,
.data-table td {
  padding: 1rem;
  text-align: left;
  border-bottom: 1px solid #dee2e6;
}

.data-table th {
  background-color: #f8f9fa;
  font-weight: 600;
  color: #495057;
  position: relative;
}

.data-table th.sortable {
  cursor: pointer;
  user-select: none;
}

.data-table th.sortable:hover {
  background-color: #e9ecef;
}

.data-table th.active {
  background-color: #e3f2fd;
  color: #1976d2;
}

.sort-icon {
  position: absolute;
  right: 0.5rem;
  top: 50%;
  transform: translateY(-50%);
  color: #6c757d;
}

.table-row {
  transition: background-color 0.15s ease-in-out;
}

.table-row:hover {
  background-color: #f8f9fa;
}

.table-row.inactive {
  opacity: 0.6;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.inactive-badge {
  display: inline-block;
  padding: 0.25rem 0.5rem;
  background-color: #6c757d;
  color: white;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 500;
}

.user-email a {
  color: #007bff;
  text-decoration: none;
}

.user-email a:hover {
  text-decoration: underline;
}

.action-buttons {
  display: flex;
  gap: 0.25rem;
}

/* ===== ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ ===== */
.pagination-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.5rem;
  border-top: 1px solid #dee2e6;
  background-color: #f8f9fa;
}

.pagination-info {
  font-weight: 500;
  color: #495057;
}

.pagination {
  display: flex;
  gap: 0.25rem;
}

.btn-pagination {
  padding: 0.5rem 0.75rem;
  background-color: white;
  border: 1px solid #dee2e6;
  color: #495057;
  font-size: 0.875rem;
}

.btn-pagination.active {
  background-color: #007bff;
  border-color: #007bff;
  color: white;
}

.btn-pagination:hover:not(:disabled):not(.active) {
  background-color: #f8f9fa;
}

.pagination-ellipsis {
  padding: 0.5rem 0.25rem;
  color: #6c757d;
}

/* ===== çŠ¶æ…‹è¡¨ç¤º ===== */
.loading-container,
.error-container,
.empty-container {
  padding: 4rem 2rem;
  text-align: center;
}

.loading-spinner {
  width: 3rem;
  height: 3rem;
  border: 0.3rem solid #f3f3f3;
  border-top: 0.3rem solid #007bff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 1rem;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.spinning {
  animation: spin 1s linear infinite;
}

.error-message h3,
.empty-message h3 {
  color: #495057;
  margin-bottom: 1rem;
}

.error-message p,
.empty-message p {
  color: #6c757d;
  margin-bottom: 1.5rem;
}

/* ===== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ ===== */
@media (max-width: 1200px) {
  .form-row {
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
}

@media (max-width: 768px) {
  .user-management {
    padding: 1rem;
  }
  
  .management-header {
    flex-direction: column;
    gap: 1rem;
  }
  
  .form-row {
    grid-template-columns: 1fr;
  }
  
  .table-info {
    flex-direction: column;
    gap: 1rem;
  }
  
  .pagination-container {
    flex-direction: column;
    gap: 1rem;
  }
  
  .data-table {
    font-size: 0.875rem;
  }
  
  .data-table th,
  .data-table td {
    padding: 0.75rem 0.5rem;
  }
}
</style>
```

---

## 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–æˆ¦ç•¥ {#database-optimization}

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆã¨æœ€é©åŒ–

```sql
-- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–ã®ãŸã‚ã®SQLã‚¹ã‚¯ãƒªãƒ—ãƒˆ

-- 1. åŸºæœ¬ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆå˜ä¸€ã‚«ãƒ©ãƒ ï¼‰
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_created_at ON users(created_at);
CREATE INDEX idx_users_is_active ON users(is_active);
CREATE INDEX idx_users_is_deleted ON users(is_deleted);

-- 2. è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆè¤‡æ•°ã‚«ãƒ©ãƒ ã®çµ„ã¿åˆã‚ã›ï¼‰
-- ã‚ˆãä½¿ã‚ã‚Œã‚‹æ¤œç´¢æ¡ä»¶ã®çµ„ã¿åˆã‚ã›ã«å¯¾å¿œ
CREATE INDEX idx_users_active_deleted ON users(is_active, is_deleted);
CREATE INDEX idx_users_city_age ON users(city, age) WHERE is_deleted = FALSE;
CREATE INDEX idx_users_created_active ON users(created_at, is_active) WHERE is_deleted = FALSE;

-- 3. éƒ¨åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆæ¡ä»¶ä»˜ãã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰
-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–
CREATE INDEX idx_users_active_name ON users(name) WHERE is_active = TRUE AND is_deleted = FALSE;
CREATE INDEX idx_users_active_email ON users(email) WHERE is_active = TRUE AND is_deleted = FALSE;

-- 4. é–¢æ•°ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆæ¤œç´¢æœ€é©åŒ–ï¼‰
-- å¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„æ¤œç´¢ç”¨
CREATE INDEX idx_users_name_lower ON users(LOWER(name)) WHERE is_deleted = FALSE;
CREATE INDEX idx_users_email_lower ON users(LOWER(email)) WHERE is_deleted = FALSE;

-- 5. ã‚«ãƒãƒªãƒ³ã‚°ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆINCLUDEå¥ä½¿ç”¨ï¼‰
-- ã‚ˆãä½¿ã‚ã‚Œã‚‹ã‚«ãƒ©ãƒ ã‚’å«ã‚€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_users_search_covering ON users(is_active, city, age) 
INCLUDE (name, email, created_at) WHERE is_deleted = FALSE;

-- 6. GINã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆå…¨æ–‡æ¤œç´¢ç”¨ï¼‰- PostgreSQL
CREATE EXTENSION IF NOT EXISTS pg_trgm;
CREATE INDEX idx_users_name_gin ON users USING gin(name gin_trgm_ops) WHERE is_deleted = FALSE;

-- 7. ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_users_created_year ON users(EXTRACT(YEAR FROM created_at), is_deleted);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨çŠ¶æ³ã®ç¢ºèªã‚¯ã‚¨ãƒª
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan as index_scans,
    idx_tup_read as tuples_read,
    idx_tup_fetch as tuples_fetched
FROM pg_stat_user_indexes 
WHERE tablename = 'users'
ORDER BY idx_scan DESC;
```

### é«˜åº¦ãªã‚¯ã‚¨ãƒªæœ€é©åŒ–

```python
# utils/database.py - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

import logging
from django.db import connection
from django.conf import settings
from typing import Dict, List, Any, Optional
from contextlib import contextmanager
import time

logger = logging.getLogger(__name__)

class QueryOptimizer:
    """
    ã‚¯ã‚¨ãƒªæœ€é©åŒ–ã®ãŸã‚ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹
    ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ã€ã‚¯ã‚¨ãƒªåˆ†æã€æœ€é©åŒ–ææ¡ˆæ©Ÿèƒ½ã‚’æä¾›
    """
    
    @staticmethod
    @contextmanager
    def query_profiler(query_name: str):
        """
        ã‚¯ã‚¨ãƒªå®Ÿè¡Œæ™‚é–“ã‚’æ¸¬å®šã™ã‚‹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
        
        ä½¿ç”¨ä¾‹:
        with QueryOptimizer.query_profiler('user_search'):
            # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ
            results = cursor.execute(sql, params)
        """
        start_time = time.time()
        
        try:
            yield
        finally:
            execution_time = time.time() - start_time
            
            # å®Ÿè¡Œæ™‚é–“ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
            logger.info(f"Query '{query_name}' executed in {execution_time:.3f}s")
            
            # é•·æ™‚é–“å®Ÿè¡Œã‚¯ã‚¨ãƒªã‚’è­¦å‘Š
            if execution_time > settings.SLOW_QUERY_THRESHOLD:
                logger.warning(f"Slow query detected: '{query_name}' took {execution_time:.3f}s")
    
    @staticmethod
    def analyze_query_plan(sql: str, params: List[Any] = None) -> Dict[str, Any]:
        """
        SQLã‚¯ã‚¨ãƒªã®å®Ÿè¡Œè¨ˆç”»ã‚’åˆ†æ
        
        Args:
            sql: åˆ†æã™ã‚‹SQLã‚¯ã‚¨ãƒª
            params: SQLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼
            
        Returns:
            å®Ÿè¡Œè¨ˆç”»ã®è©³ç´°æƒ…å ±
        """
        with connection.cursor() as cursor:
            # PostgreSQLã®å®Ÿè¡Œè¨ˆç”»ã‚’å–å¾—
            explain_sql = f"EXPLAIN (ANALYZE, BUFFERS, FORMAT JSON) {sql}"
            
            try:
                cursor.execute(explain_sql, params or [])
                plan_result = cursor.fetchone()[0]
                
                # å®Ÿè¡Œè¨ˆç”»ã‚’è§£æ
                analysis = QueryOptimizer._parse_execution_plan(plan_result[0])
                
                return {
                    'execution_time': analysis.get('Execution Time', 0),
                    'planning_time': analysis.get('Planning Time', 0),
                    'total_cost': analysis.get('Total Cost', 0),
                    'rows_returned': analysis.get('Actual Rows', 0),
                    'sequential_scans': analysis.get('Sequential Scans', 0),
                    'index_scans': analysis.get('Index Scans', 0),
                    'recommendations': QueryOptimizer._generate_recommendations(analysis)
                }
                
            except Exception as e:
                logger.error(f"Query plan analysis failed: {str(e)}")
                return {'error': str(e)}
    
    @staticmethod
    def _parse_execution_plan(plan: Dict[str, Any]) -> Dict[str, Any]:
        """å®Ÿè¡Œè¨ˆç”»ã‚’è§£æã—ã¦é‡è¦ãªæƒ…å ±ã‚’æŠ½å‡º"""
        analysis = {
            'Execution Time': plan.get('Execution Time', 0),
            'Planning Time': plan.get('Planning Time', 0),
            'Total Cost': 0,
            'Actual Rows': 0,
            'Sequential Scans': 0,
            'Index Scans': 0,
            'Nested Loops': 0,
            'Hash Joins': 0,
            'Sort Operations': 0
        }
        
        def extract_node_info(node):
            """ãƒãƒ¼ãƒ‰æƒ…å ±ã‚’å†å¸°çš„ã«æŠ½å‡º"""
            if not isinstance(node, dict):
                return
            
            # ãƒãƒ¼ãƒ‰ç¨®åˆ¥ã«ã‚ˆã‚‹åˆ†é¡
            node_type = node.get('Node Type', '')
            
            if 'Seq Scan' in node_type:
                analysis['Sequential Scans'] += 1
            elif 'Index' in node_type:
                analysis['Index Scans'] += 1
            elif 'Nested Loop' in node_type:
                analysis['Nested Loops'] += 1
            elif 'Hash Join' in node_type:
                analysis['Hash Joins'] += 1
            elif 'Sort' in node_type:
                analysis['Sort Operations'] += 1
            
            # ã‚³ã‚¹ãƒˆã¨è¡Œæ•°ã‚’ç´¯ç©
            analysis['Total Cost'] += node.get('Total Cost', 0)
            analysis['Actual Rows'] += node.get('Actual Rows', 0)
            
            # å­ãƒãƒ¼ãƒ‰ã‚’å†å¸°çš„ã«å‡¦ç†
            if 'Plans' in node:
                for child_node in node['Plans']:
                    extract_node_info(child_node)
        
        # ãƒ—ãƒ©ãƒ³ã®æœ€ä¸Šä½ãƒãƒ¼ãƒ‰ã‹ã‚‰é–‹å§‹
        if 'Plan' in plan:
            extract_node_info(plan['Plan'])
        
        return analysis
    
    @staticmethod
    def _generate_recommendations(analysis: Dict[str, Any]) -> List[str]:
        """å®Ÿè¡Œè¨ˆç”»åˆ†æçµæœã‹ã‚‰æœ€é©åŒ–ææ¡ˆã‚’ç”Ÿæˆ"""
        recommendations = []
        
        # ã‚·ãƒ¼ã‚±ãƒ³ã‚·ãƒ£ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ãŒå¤šã„å ´åˆ
        if analysis.get('Sequential Scans', 0) > 0:
            recommendations.append(
                "ã‚·ãƒ¼ã‚±ãƒ³ã‚·ãƒ£ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚é©åˆ‡ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä½œæˆã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚"
            )
        
        # å®Ÿè¡Œæ™‚é–“ãŒé•·ã„å ´åˆ
        if analysis.get('Execution Time', 0) > 1000:  # 1ç§’ä»¥ä¸Š
            recommendations.append(
                "ã‚¯ã‚¨ãƒªã®å®Ÿè¡Œæ™‚é–“ãŒé•·ã™ãã¾ã™ã€‚WHEREå¥ã®æœ€é©åŒ–ã‚„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¦‹ç›´ã—ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚"
            )
        
        # ã‚½ãƒ¼ãƒˆæ“ä½œãŒå¤šã„å ´åˆ
        if analysis.get('Sort Operations', 0) > 2:
            recommendations.append(
                "å¤šæ•°ã®ã‚½ãƒ¼ãƒˆæ“ä½œãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚ORDER BYã«å¯¾å¿œã™ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚"
            )
        
        # ãƒã‚¹ãƒˆãƒ«ãƒ¼ãƒ—ãŒå¤šã„å ´åˆ
        if analysis.get('Nested Loops', 0) > 3:
            recommendations.append(
                "å¤šæ•°ã®ãƒã‚¹ãƒˆãƒ«ãƒ¼ãƒ—ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚JOINã®é †åºã‚„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æœ€é©åŒ–ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚"
            )
        
        return recommendations

class BatchProcessor:
    """
    å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®ãŸã‚ã®ãƒãƒƒãƒå‡¦ç†ã‚¯ãƒ©ã‚¹
    ãƒ¡ãƒ¢ãƒªåŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚’æä¾›
    """
    
    def __init__(self, batch_size: int = 1000):
        self.batch_size = batch_size
    
    def process_in_batches(self, query: str, params: List[Any], 
                          processor_func: callable) -> Dict[str, Any]:
        """
        å¤§é‡ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒãƒå‡¦ç†ã§åŠ¹ç‡çš„ã«å‡¦ç†
        
        Args:
            query: ãƒãƒƒãƒå‡¦ç†ç”¨SQLï¼ˆLIMIT/OFFSETã‚’å«ã‚€ï¼‰
            params: SQLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼
            processor_func: å„ãƒãƒƒãƒã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
            
        Returns:
            å‡¦ç†çµæœã®çµ±è¨ˆæƒ…å ±
        """
        total_processed = 0
        batch_count = 0
        errors = []
        
        with connection.cursor() as cursor:
            offset = 0
            
            while True:
                # ãƒãƒƒãƒç”¨ã‚¯ã‚¨ãƒªã‚’æ§‹ç¯‰
                batch_query = f"{query} LIMIT %s OFFSET %s"
                batch_params = params + [self.batch_size, offset]
                
                try:
                    # ãƒãƒƒãƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    cursor.execute(batch_query, batch_params)
                    rows = cursor.fetchall()
                    
                    # ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯çµ‚äº†
                    if not rows:
                        break
                    
                    # ã‚«ãƒ©ãƒ åã‚’å–å¾—
                    columns = [desc[0] for desc in cursor.description]
                    
                    # ãƒ‡ãƒ¼ã‚¿ã‚’è¾æ›¸å½¢å¼ã«å¤‰æ›
                    batch_data = []
                    for row in rows:
                        batch_data.append(dict(zip(columns, row)))
                    
                    # ãƒãƒƒãƒå‡¦ç†ã‚’å®Ÿè¡Œ
                    processor_func(batch_data)
                    
                    total_processed += len(batch_data)
                    batch_count += 1
                    offset += self.batch_size
                    
                    # ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º
                    if batch_count % 10 == 0:
                        logger.info(f"Processed {total_processed} records in {batch_count} batches")
                        
                except Exception as e:
                    error_msg = f"Batch {batch_count} failed: {str(e)}"
                    logger.error(error_msg)
                    errors.append(error_msg)
                    break
        
        return {
            'total_processed': total_processed,
            'batch_count': batch_count,
            'errors': errors
        }

class CacheManager:
    """
    é«˜åº¦ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†ã‚¯ãƒ©ã‚¹
    éšå±¤åŒ–ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–æˆ¦ç•¥ã‚’æä¾›
    """
    
    @staticmethod
    def get_multi_level_cache(keys: List[str], 
                             fallback_func: callable,
                             cache_timeout: int = 300) -> Dict[str, Any]:
        """
        å¤šå±¤ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        
        Args:
            keys: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã®ãƒªã‚¹ãƒˆ
            fallback_func: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹æ™‚ã®ä»£æ›¿å‡¦ç†é–¢æ•°
            cache_timeout: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé™ï¼ˆç§’ï¼‰
            
        Returns:
            ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
        """
        from django.core.cache import cache
        
        results = {}
        missing_keys = []
        
        # ç¬¬1å±¤: Redisã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—
        for key in keys:
            cached_value = cache.get(key)
            if cached_value is not None:
                results[key] = cached_value
            else:
                missing_keys.append(key)
        
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹ãŒã‚ã‚‹å ´åˆ
        if missing_keys:
            # ç¬¬2å±¤: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—
            fresh_data = fallback_func(missing_keys)
            
            # æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
            cache_data = {}
            for key in missing_keys:
                if key in fresh_data:
                    cache_data[key] = fresh_data[key]
            
            cache.set_many(cache_data, timeout=cache_timeout)
            results.update(fresh_data)
        
        return results
    
    @staticmethod
    def invalidate_pattern(pattern: str):
        """
        ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã«ã‚ˆã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
        
        Args:
            pattern: ç„¡åŠ¹åŒ–ã™ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆä¾‹: "user_*"ï¼‰
        """
        from django.core.cache import cache
        
        try:
            # Redisã®å ´åˆã®ã‚­ãƒ¼å‰Šé™¤
            import redis
            from django.conf import settings
            
            redis_client = redis.Redis.from_url(settings.CACHES['default']['LOCATION'])
            keys = redis_client.keys(pattern)
            
            if keys:
                redis_client.delete(*keys)
                logger.info(f"Invalidated {len(keys)} cache keys matching pattern: {pattern}")
                
        except ImportError:
            # RedisãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            logger.warning("Redis not available for pattern-based cache invalidation")
```

---

## 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ– {#security-hardening}

### ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºãƒ¬ãƒ™ãƒ«ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®Ÿè£…

```python
# security/middleware.py - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

import hashlib
import hmac
import time
import json
import logging
from django.http import JsonResponse
from django.conf import settings
from django.utils.deprecation import MiddlewareMixin
from django.core.cache import cache
from django.utils import timezone
from datetime import timedelta
from typing import Dict, Any, Optional

logger = logging.getLogger(__name__)

class SecurityMiddleware(MiddlewareMixin):
    """
    åŒ…æ‹¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
    ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¤œè¨¼ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®šã‚’æä¾›
    """
    
    def __init__(self, get_response=None):
        super().__init__(get_response)
        self.rate_limiter = RateLimiter()
        self.request_validator = RequestValidator()
        self.security_headers = SecurityHeaders()
    
    def process_request(self, request):
        """ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‰å‡¦ç†"""
        
        # 1. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
        if not self.rate_limiter.is_allowed(request):
            logger.warning(f"Rate limit exceeded for {self.get_client_ip(request)}")
            return JsonResponse({
                'error': 'Rate limit exceeded',
                'message': 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆé »åº¦ãŒåˆ¶é™ã‚’è¶…ãˆã¦ã„ã¾ã™'
            }, status=429)
        
        # 2. ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¤œè¨¼
        validation_result = self.request_validator.validate(request)
        if not validation_result['valid']:
            logger.warning(f"Invalid request from {self.get_client_ip(request)}: {validation_result['reason']}")
            return JsonResponse({
                'error': 'Invalid request',
                'message': validation_result['reason']
            }, status=400)
        
        # 3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°è¨˜éŒ²
        self.log_request(request)
        
        return None
    
    def process_response(self, request, response):
        """ãƒ¬ã‚¹ãƒãƒ³ã‚¹å¾Œå‡¦ç†"""
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
        response = self.security_headers.add_headers(response)
        
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ­ã‚°è¨˜éŒ²
        self.log_response(request, response)
        
        return response
    
    def get_client_ip(self, request) -> str:
        """ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—"""
        x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
        
        if x_forwarded_for:
            # ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã®å ´åˆã€æœ€åˆã®IPã‚’å–å¾—
            ip = x_forwarded_for.split(',')[0].strip()
        else:
            ip = request.META.get('REMOTE_ADDR', 'unknown')
        
        return ip
    
    def log_request(self, request):
        """ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ­ã‚°ã‚’è¨˜éŒ²"""
        log_data = {
            'timestamp': timezone.now().isoformat(),
            'method': request.method,
            'path': request.path,
            'ip': self.get_client_ip(request),
            'user_agent': request.META.get('HTTP_USER_AGENT', ''),
            'referer': request.META.get('HTTP_REFERER', ''),
            'content_length': request.META.get('CONTENT_LENGTH', 0)
        }
        
        logger.info(f"Request: {json.dumps(log_data)}")
    
    def log_response(self, request, response):
        """ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ­ã‚°ã‚’è¨˜éŒ²"""
        log_data = {
            'timestamp': timezone.now().isoformat(),
            'method': request.method,
            'path': request.path,
            'ip': self.get_client_ip(request),
            'status_code': response.status_code,
            'response_size': len(response.content) if hasattr(response, 'content') else 0
        }
        
        # ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å ´åˆã¯è­¦å‘Šãƒ¬ãƒ™ãƒ«
        if response.status_code >= 400:
            logger.warning(f"Error Response: {json.dumps(log_data)}")
        else:
            logger.info(f"Response: {json.dumps(log_data)}")

class RateLimiter:
    """
    é«˜åº¦ãªãƒ¬ãƒ¼ãƒˆåˆ¶é™æ©Ÿèƒ½
    è¤‡æ•°ã®åˆ¶é™ãƒ«ãƒ¼ãƒ«ã¨ã‚¢ãƒ€ãƒ—ãƒ†ã‚£ãƒ–åˆ¶é™ã‚’æä¾›
    """
    
    def __init__(self):
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¨­å®š
        self.default_limits = {
            'requests_per_minute': 60,      # 1åˆ†é–“ã«60ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            'requests_per_hour': 1000,      # 1æ™‚é–“ã«1000ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            'requests_per_day': 10000       # 1æ—¥ã«10000ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        }
        
        # APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåˆ¥ã®åˆ¶é™è¨­å®š
        self.endpoint_limits = {
            '/api/users/': {
                'requests_per_minute': 30,
                'requests_per_hour': 500
            },
            '/api/users/search/': {
                'requests_per_minute': 20,
                'requests_per_hour': 300
            }
        }
    
    def is_allowed(self, request) -> bool:
        """ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒåˆ¶é™å†…ã‹ãƒã‚§ãƒƒã‚¯"""
        client_ip = self.get_client_ip(request)
        endpoint = request.path
        
        # ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå›ºæœ‰ã®åˆ¶é™ã‚’å–å¾—
        limits = self.endpoint_limits.get(endpoint, self.default_limits)
        
        # å„æ™‚é–“æ ã§ãƒã‚§ãƒƒã‚¯
        for period, limit in limits.items():
            if not self.check_limit(client_ip, endpoint, period, limit):
                return False
        
        # åˆ¶é™å†…ã®å ´åˆã€ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’å¢—åŠ 
        self.increment_counters(client_ip, endpoint)
        return True
    
    def check_limit(self, client_ip: str, endpoint: str, 
                   period: str, limit: int) -> bool:
        """æŒ‡å®šæœŸé–“ã®åˆ¶é™ã‚’ãƒã‚§ãƒƒã‚¯"""
        
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã‚’ç”Ÿæˆ
        cache_key = f"rate_limit:{client_ip}:{endpoint}:{period}"
        
        # ç¾åœ¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚’å–å¾—
        current_count = cache.get(cache_key, 0)
        
        return current_count < limit
    
    def increment_counters(self, client_ip: str, endpoint: str):
        """ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’å¢—åŠ """
        
        # å„æœŸé–“ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’å¢—åŠ 
        periods = {
            'requests_per_minute': 60,      # 60ç§’
            'requests_per_hour': 3600,      # 3600ç§’
            'requests_per_day': 86400       # 86400ç§’
        }
        
        for period, timeout in periods.items():
            cache_key = f"rate_limit:{client_ip}:{endpoint}:{period}"
            
            try:
                # ã‚¢ãƒˆãƒŸãƒƒã‚¯ãªå¢—åŠ æ“ä½œ
                current_count = cache.get(cache_key, 0)
                cache.set(cache_key, current_count + 1, timeout=timeout)
                
            except Exception as e:
                logger.error(f"Failed to increment rate limit counter: {str(e)}")
    
    def get_client_ip(self, request) -> str:
        """ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIPã‚’å–å¾—ï¼ˆSecurityMiddlewareã¨åŒã˜å®Ÿè£…ï¼‰"""
        x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
        
        if x_forwarded_for:
            ip = x_forwarded_for.split(',')[0].strip()
        else:
            ip = request.META.get('REMOTE_ADDR', 'unknown')
        
        return ip

class RequestValidator:
    """
    ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¤œè¨¼ã‚¯ãƒ©ã‚¹
    æ‚ªæ„ã®ã‚ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚„ã‚¹ãƒ‘ãƒ ã‚’æ¤œå‡º
    """
    
    def __init__(self):
        # ç¦æ­¢ã•ã‚ŒãŸUser-Agentãƒ‘ã‚¿ãƒ¼ãƒ³
        self.blocked_user_agents = [
            'bot', 'crawler', 'spider', 'scraper',
            'curl', 'wget', 'python-requests'
        ]
        
        # æœ€å¤§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚µã‚¤ã‚ºï¼ˆãƒã‚¤ãƒˆï¼‰
        self.max_request_size = 10 * 1024 * 1024  # 10MB
        
        # ç¦æ­¢ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­
        self.blocked_extensions = [
            '.php', '.asp', '.jsp', '.cgi'
        ]
    
    def validate(self, request) -> Dict[str, Any]:
        """ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åŒ…æ‹¬çš„ã«æ¤œè¨¼"""
        
        # 1. User-Agentãƒã‚§ãƒƒã‚¯
        user_agent = request.META.get('HTTP_USER_AGENT', '').lower()
        if any(blocked in user_agent for blocked in self.blocked_user_agents):
            return {
                'valid': False,
                'reason': 'Blocked User-Agent detected'
            }
        
        # 2. ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
        content_length = int(request.META.get('CONTENT_LENGTH', 0))
        if content_length > self.max_request_size:
            return {
                'valid': False,
                'reason': 'Request size too large'
            }
        
        # 3. ãƒ‘ã‚¹æ¤œè¨¼
        if any(ext in request.path.lower() for ext in self.blocked_extensions):
            return {
                'valid': False,
                'reason': 'Blocked file extension in path'
            }
        
        # 4. SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ¤œå‡º
        if self.detect_sql_injection(request):
            return {
                'valid': False,
                'reason': 'Potential SQL injection detected'
            }
        
        # 5. XSSæ¤œå‡º
        if self.detect_xss(request):
            return {
                'valid': False,
                'reason': 'Potential XSS attack detected'
            }
        
        return {'valid': True}
    
    def detect_sql_injection(self, request) -> bool:
        """SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒã‚’æ¤œå‡º"""
        sql_patterns = [
            'union select', 'drop table', 'insert into',
            'delete from', 'update set', 'exec(', 'execute(',
            'sp_', 'xp_', '--', ';--', '/*', '*/'
        ]
        
        # URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
        query_string = request.META.get('QUERY_STRING', '').lower()
        if any(pattern in query_string for pattern in sql_patterns):
            return True
        
        # POSTãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯
        if hasattr(request, 'body') and request.body:
            try:
                body_str = request.body.decode('utf-8').lower()
                if any(pattern in body_str for pattern in sql_patterns):
                    return True
            except UnicodeDecodeError:
                pass  # ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        
        return False
    
    def detect_xss(self, request) -> bool:
        """XSSæ”»æ’ƒã‚’æ¤œå‡º"""
        xss_patterns = [
            '<script', 'javascript:', 'vbscript:',
            'onload=', 'onerror=', 'onclick=',
            'eval(', 'expression('
        ]
        
        # URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
        query_string = request.META.get('QUERY_STRING', '').lower()
        if any(pattern in query_string for pattern in xss_patterns):
            return True
        
        # POSTãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯
        if hasattr(request, 'body') and request.body:
            try:
                body_str = request.body.decode('utf-8').lower()
                if any(pattern in body_str for pattern in xss_patterns):
                    return True
            except UnicodeDecodeError:
                pass
        
        return False

class SecurityHeaders:
    """
    ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ç®¡ç†ã‚¯ãƒ©ã‚¹
    OWASPæ¨å¥¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®š
    """
    
    def add_headers(self, response):
        """ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«è¿½åŠ """
        
        # Content Security Policy
        response['Content-Security-Policy'] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "connect-src 'self'; "
            "font-src 'self' https://fonts.gstatic.com; "
            "object-src 'none'; "
            "frame-ancestors 'none'"
        )
        
        # X-Frame-Optionsï¼ˆã‚¯ãƒªãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚­ãƒ³ã‚°å¯¾ç­–ï¼‰
        response['X-Frame-Options'] = 'DENY'
        
        # X-Content-Type-Optionsï¼ˆMIMEã‚¿ã‚¤ãƒ—ã‚¹ãƒ‹ãƒƒãƒ•ã‚£ãƒ³ã‚°å¯¾ç­–ï¼‰
        response['X-Content-Type-Options'] = 'nosniff'
        
        # X-XSS-Protectionï¼ˆXSSä¿è­·ï¼‰
        response['X-XSS-Protection'] = '1; mode=block'
        
        # Strict-Transport-Securityï¼ˆHTTPSå¼·åˆ¶ï¼‰
        if settings.SECURE_SSL_REDIRECT:
            response['Strict-Transport-Security'] = (
                'max-age=31536000; includeSubDomains; preload'
            )
        
        # Referrer-Policyï¼ˆãƒªãƒ•ã‚¡ãƒ©ãƒ¼åˆ¶å¾¡ï¼‰
        response['Referrer-Policy'] = 'strict-origin-when-cross-origin'
        
        # Permissions-Policyï¼ˆæ©Ÿèƒ½åˆ¶é™ï¼‰
        response['Permissions-Policy'] = (
            'geolocation=(), microphone=(), camera=(), '
            'payment=(), usb=(), magnetometer=(), gyroscope=()'
        )
        
        return response

class DataEncryption:
    """
    ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–ã‚¯ãƒ©ã‚¹
    æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–ãƒ»å¾©å·åŒ–æ©Ÿèƒ½ã‚’æä¾›
    """
    
    def __init__(self):
        self.key = settings.SECRET_KEY.encode()[:32]  # 32ãƒã‚¤ãƒˆã‚­ãƒ¼
    
    def encrypt_sensitive_data(self, data: str) -> str:
        """æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–"""
        from cryptography.fernet import Fernet
        import base64
        
        # ã‚­ãƒ¼ã‹ã‚‰Fernetã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆ
        key = base64.urlsafe_b64encode(self.key)
        fernet = Fernet(key)
        
        # ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–
        encrypted_data = fernet.encrypt(data.encode())
        
        return base64.urlsafe_b64encode(encrypted_data).decode()
    
    def decrypt_sensitive_data(self, encrypted_data: str) -> str:
        """æš—å·åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å¾©å·åŒ–"""
        from cryptography.fernet import Fernet
        import base64
        
        try:
            # ã‚­ãƒ¼ã‹ã‚‰Fernetã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆ
            key = base64.urlsafe_b64encode(self.key)
            fernet = Fernet(key)
            
            # ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å·åŒ–
            encrypted_bytes = base64.urlsafe_b64decode(encrypted_data.encode())
            decrypted_data = fernet.decrypt(encrypted_bytes)
            
            return decrypted_data.decode()
            
        except Exception as e:
            logger.error(f"Decryption failed: {str(e)}")
            raise ValueError("ãƒ‡ãƒ¼ã‚¿ã®å¾©å·åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ")
    
    def hash_password(self, password: str) -> str:
        """ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–"""
        import bcrypt
        
        # ã‚½ãƒ«ãƒˆã‚’ç”Ÿæˆã—ã¦ãƒãƒƒã‚·ãƒ¥åŒ–
        salt = bcrypt.gensalt()
        hashed = bcrypt.hashpw(password.encode('utf-8'), salt)
        
        return hashed.decode('utf-8')
    
    def verify_password(self, password: str, hashed: str) -> bool:
        """ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œè¨¼"""
        import bcrypt
        
        try:
            return bcrypt.checkpw(
                password.encode('utf-8'), 
                hashed.encode('utf-8')
            )
        except Exception:
            return False
```

---

## 6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ {#performance}

### é«˜æ€§èƒ½ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ

```python
# performance/optimization.py - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

import asyncio
import aiohttp
import concurrent.futures
from django.db import connections
from django.core.cache import cache
from django.conf import settings
import logging
import time
from typing import List, Dict, Any, Optional, Callable
from dataclasses import dataclass
from contextlib import contextmanager

logger = logging.getLogger(__name__)

@dataclass
class PerformanceMetrics:
    """ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ã‚’æ ¼ç´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹"""
    operation_name: str
    start_time: float
    end_time: float
    execution_time: float
    memory_usage: int
    cache_hits: int
    cache_misses: int
    database_queries: int

class PerformanceMonitor:
    """
    ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ã‚¯ãƒ©ã‚¹
    å®Ÿè¡Œæ™‚é–“ã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡ã‚’è¿½è·¡
    """
    
    def __init__(self):
        self.metrics_history = []
        self.active_operations = {}
    
    @contextmanager
    def monitor_operation(self, operation_name: str):
        """
        æ“ä½œã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç›£è¦–ã™ã‚‹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
        
        ä½¿ç”¨ä¾‹:
        with performance_monitor.monitor_operation('user_search'):
            # ç›£è¦–å¯¾è±¡ã®å‡¦ç†
            results = perform_search()
        """
        import psutil
        import gc
        
        # é–‹å§‹æ™‚ã®çŠ¶æ…‹ã‚’è¨˜éŒ²
        start_time = time.time()
        start_memory = psutil.Process().memory_info().rss
        start_queries = len(connections['default'].queries)
        
        # ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
        gc.collect()
        
        try:
            yield
            
        finally:
            # çµ‚äº†æ™‚ã®çŠ¶æ…‹ã‚’è¨˜éŒ²
            end_time = time.time()
            end_memory = psutil.Process().memory_info().rss
            end_queries = len(connections['default'].queries)
            
            # ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ä½œæˆ
            metrics = PerformanceMetrics(
                operation_name=operation_name,
                start_time=start_time,
                end_time=end_time,
                execution_time=end_time - start_time,
                memory_usage=end_memory - start_memory,
                cache_hits=0,  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥çµ±è¨ˆã¯åˆ¥é€”å®Ÿè£…
                cache_misses=0,
                database_queries=end_queries - start_queries
            )
            
            # ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ä¿å­˜
            self.metrics_history.append(metrics)
            
            # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ­ã‚°ã‚’å‡ºåŠ›
            self.log_performance(metrics)
    
    def log_performance(self, metrics: PerformanceMetrics):
        """ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ãƒ­ã‚°å‡ºåŠ›"""
        log_message = (
            f"Performance: {metrics.operation_name} - "
            f"Time: {metrics.execution_time:.3f}s, "
            f"Memory: {metrics.memory_usage / 1024 / 1024:.2f}MB, "
            f"Queries: {metrics.database_queries}"
        )
        
        # é•·æ™‚é–“å®Ÿè¡Œã®å ´åˆã¯è­¦å‘Š
        if metrics.execution_time > 2.0:
            logger.warning(f"Slow operation detected: {log_message}")
        else:
            logger.info(log_message)
    
    def get_performance_summary(self, operation_name: str = None) -> Dict[str, Any]:
        """ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚µãƒãƒªãƒ¼ã‚’å–å¾—"""
        if operation_name:
            relevant_metrics = [
                m for m in self.metrics_history 
                if m.operation_name == operation_name
            ]
        else:
            relevant_metrics = self.metrics_history
        
        if not relevant_metrics:
            return {}
        
        execution_times = [m.execution_time for m in relevant_metrics]
        memory_usages = [m.memory_usage for m in relevant_metrics]
        query_counts = [m.database_queries for m in relevant_metrics]
        
        return {
            'operation_count': len(relevant_metrics),
            'avg_execution_time': sum(execution_times) / len(execution_times),
            'max_execution_time': max(execution_times),
            'min_execution_time': min(execution_times),
            'avg_memory_usage': sum(memory_usages) / len(memory_usages),
            'avg_query_count': sum(query_counts) / len(query_counts),
            'total_operations': len(self.metrics_history)
        }

class AsyncProcessor:
    """
    éåŒæœŸå‡¦ç†ã‚¯ãƒ©ã‚¹
    I/Oé›†ç´„çš„ãªæ“ä½œã‚’ä¸¦åˆ—å®Ÿè¡Œ
    """
    
    def __init__(self, max_workers: int = 10):
        self.max_workers = max_workers
        self.executor = concurrent.futures.ThreadPoolExecu
